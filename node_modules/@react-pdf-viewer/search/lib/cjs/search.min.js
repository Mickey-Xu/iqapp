"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("@react-pdf-viewer/core"),n=function(){return e.createElement(t.Icon,{size:16},e.createElement("path",{d:"M0.541,5.627L11.666,18.2c0.183,0.207,0.499,0.226,0.706,0.043c0.015-0.014,0.03-0.028,0.043-0.043\n                L23.541,5.627"}))},r=function(){return e.createElement(t.Icon,{size:16},e.createElement("path",{d:"M23.535,18.373L12.409,5.8c-0.183-0.207-0.499-0.226-0.706-0.043C11.688,5.77,11.674,5.785,11.66,5.8\n                L0.535,18.373"}))},o=function(){return e.createElement(t.Icon,{size:16},e.createElement("path",{d:"M10.5,0.5c5.523,0,10,4.477,10,10s-4.477,10-10,10s-10-4.477-10-10S4.977,0.5,10.5,0.5z\n                M23.5,23.5\n                l-5.929-5.929"}))},c=function(){return(c=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};var a=new RegExp(" "),u=function(e){var t=e.wholeWords?" "+e.keyword+" ":e.keyword,n=e.matchCase?"g":"gi";return new RegExp(t,n)},s=function(e,t,n){return e instanceof RegExp?e:"string"==typeof e?""===e?a:u({keyword:e,matchCase:t||!1,wholeWords:n||!1}):(void 0!==t&&(e.matchCase=t),void 0!==n&&(e.wholeWords=n),u(e))},i=function(t){var n=e.useState(t.get("doc")),r=n[0],o=n[1],c=function(e){o(e)};return e.useEffect((function(){return t.subscribe("doc",c),function(){t.unsubscribe("doc",c)}}),[]),{currentDoc:r}},l=function(t){var n,r=i(t).currentDoc,o=e.useState([]),c=o[0],u=o[1],l=e.useState([]),h=l[0],f=l[1],d=e.useState(0),p=d[0],m=d[1],g=e.useState(!1),v=g[0],x=g[1],E=e.useRef([]),y=e.useState(!1),w=y[0],C=y[1],S=function(e){return u(""===e?[]:[e])},I=function(e){var n=t.get("jumpToPage");n&&n(e.pageIndex),t.update("match",e)},b=function(e,n,o){var c=e.map((function(e){return s(e,n,o)}));t.update("keyword",c),m(0),f([]),(0===E.current.length?function(){if(!r)return Promise.resolve([]);var e=Array(r.numPages).fill(0).map((function(e,t){return r.getPage(t+1).then((function(e){return e.getTextContent()})).then((function(e){var n=e.items.map((function(e){return e.str||""})).join("");return Promise.resolve({pageContent:n,pageIndex:t})}))}));return Promise.all(e).then((function(e){return e.sort((function(e,t){return e.pageIndex-t.pageIndex})),Promise.resolve(e.map((function(e){return e.pageContent})))}))}().then((function(e){return E.current=e,Promise.resolve(e)})):Promise.resolve(E.current)).then((function(e){var t=[];e.forEach((function(e,n){for(var r=c.map((function(t){return(e.match(t)||[]).length})).reduce((function(e,t){return e+t}),0),o=0;o<r;o++)t.push({matchIndex:o,pageIndex:n})})),f(t),t.length>0&&(m(1),I(t[0]))}))};return e.useEffect((function(){E.current=[]}),[r]),{clearKeyword:function(){0!==c.length&&(t.update("keyword",[a]),S(""),m(0),f([]),x(!1),C(!1))},changeMatchCase:function(e){x(e),c.length>0&&b(c,e,w)},changeWholeWords:function(e){C(e),c.length>0&&b(c,v,e)},currentMatch:p,jumpToNextMatch:function(){if(0!==c.length){var e=p+1,t=e<=h.length?e:1;m(t),I(h[t-1])}},jumpToPreviousMatch:function(){if(0!==c.length){var e=p-1,t=e>0?e:h.length;m(t),I(h[t-1])}},keywords:c,matchCase:v,numberOfMatches:h.length,wholeWords:w,search:function(){return b(c,v,w)},searchFor:b,setKeywords:u,keyword:0===c.length?"":(n=c[0],n instanceof RegExp?n.source:"string"==typeof n?n:n.keyword),setKeyword:S}},h=function(e){var t=e.children,n=e.store,r=l(n);return t(c({},r))},f=function(t){var n=t.children,r=t.store;return i(r).currentDoc?e.createElement(h,{store:r},n):e.createElement(e.Fragment,null)},d={left:0,top:8},p=function(o){var c=o.store,a=o.onToggle,u=e.useContext(t.LocalizationContext),s=l(c),i=s.clearKeyword,h=s.changeMatchCase,f=s.changeWholeWords,p=s.currentMatch,m=s.jumpToNextMatch,g=s.jumpToPreviousMatch,v=s.keyword,x=s.matchCase,E=s.numberOfMatches,y=s.wholeWords,w=s.search,C=s.setKeyword;return e.createElement("div",{className:"rpv-search-popover"},e.createElement("div",{className:"rpv-search-popover-input-counter"},e.createElement("input",{className:"rpv-search-popover-input",placeholder:u&&u.search?u.search.enterToSearch:"Enter to search",type:"text",value:v,onChange:function(e){C(e.target.value)},onKeyDown:function(e){13===e.keyCode&&v&&w()}}),e.createElement("div",{className:"rpv-search-popover-counter"},p,"/",E)),e.createElement("label",{className:"rpv-search-popover-label"},e.createElement("input",{className:"rpv-search-popover-label-checkbox",checked:x,type:"checkbox",onChange:function(e){h(e.target.checked)}})," ",u&&u.search?u.search.matchCase:"Match case"),e.createElement("label",{className:"rpv-search-popover-label"},e.createElement("input",{className:"rpv-search-popover-label-checkbox",checked:y,type:"checkbox",onChange:function(e){f(e.target.checked)}})," ",u&&u.search?u.search.wholeWords:"Whole words"),e.createElement("div",{className:"rpv-search-popover-footer"},e.createElement("div",{className:"rpv-search-popover-footer-item"},e.createElement(t.Tooltip,{position:t.Position.BottomCenter,target:e.createElement(t.Button,{onClick:g},e.createElement(r,null)),content:function(){return u&&u.search?u.search.previousMatch:"Previous match"},offset:d})),e.createElement("div",{className:"rpv-search-popover-footer-item"},e.createElement(t.Tooltip,{position:t.Position.BottomCenter,target:e.createElement(t.Button,{onClick:m},e.createElement(n,null)),content:function(){return u&&u.search?u.search.nextMatch:"Next match"},offset:d})),e.createElement("div",{className:"rpv-search-popover-footer-button"},e.createElement(t.PrimaryButton,{onClick:function(){a(),i()}},u&&u.search?u.search.close:"Close"))))},m=function(n){var r=n.children,c=n.onClick,a=e.useContext(t.LocalizationContext),u=a&&a.search?a.search.search:"Search";return r({icon:e.createElement(o,null),label:u,onClick:c})},g={left:0,top:8},v=function(n){var r=n.onClick;return e.createElement(m,{onClick:r},(function(n){return e.createElement(t.Tooltip,{position:t.Position.BottomCenter,target:e.createElement(t.Button,{onClick:r},n.icon),content:function(){return n.label},offset:g})}))},x={left:0,top:8},E=function(n){var r=n.children,o=n.store,a=i(o).currentDoc,u=r||function(t){return e.createElement(v,c({},t))};return a?e.createElement(t.Popover,{position:t.Position.BottomLeft,target:function(e){return u({onClick:e})},content:function(t){return e.createElement(p,{store:o,onToggle:t})},offset:x,closeOnClickOutside:!1,closeOnEscape:!0}):e.createElement(e.Fragment,null)},y=function(e){var t=e.parentNode;t&&t.removeChild(e)},w=function(e){var t=e.parentNode;if(t){var n=document.createRange();n.selectNodeContents(e),function(e,t){y(e);var n=t.parentNode;n&&n.insertBefore(e,t),y(t)}(n.extractContents(),e),t.normalize()}},C=function(n){var r=n.pageIndex,o=n.store,c=n.onHighlightKeyword,u=e.useState({matchIndex:-1,pageIndex:-1}),s=u[0],i=u[1],l=e.useState([a]),h=l[0],f=l[1],d=e.useState({pageIndex:r,scale:1,status:t.LayerRenderStatus.PreRender}),p=d[0],m=d[1],g=e.useRef(null),v=e.useRef([]),x=function(e){for(var t=e.querySelectorAll("span.rpv-search-text-highlight"),n=t.length,r=0;r<n;r++)t[r].parentElement.removeChild(t[r])},E=function(e){var t=v.current;if(0!==t.length){var n=[].slice.call(e.querySelectorAll(".rpv-core-text")),r=t.map((function(e){return e.char})).join("");h.forEach((function(o){if(o.source.trim()){for(var a,u=-1===o.flags.indexOf("g")?new RegExp(o,o.flags+"g"):o,s=[];null!==(a=u.exec(r));)s.push({keyword:u,startIndex:a.index,endIndex:u.lastIndex});s.map((function(e){return{keyword:e.keyword,indexes:t.slice(e.startIndex,e.endIndex)}})).forEach((function(t){var r=t.indexes.reduce((function(e,t){return e[t.spanIndex]=function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),o=0;for(t=0;t<n;t++)for(var c=arguments[t],a=0,u=c.length;a<u;a++,o++)r[o]=c[a];return r}(e[t.spanIndex]||[],[t]),e}),{});Object.values(r).forEach((function(r){!function(e,t,n,r){var o=document.createRange(),a=n.firstChild;if(a){var u=r[0].charIndexInSpan,s=1===r.length?u:r[r.length-1].charIndexInSpan;o.setStart(a,u),o.setEnd(a,s+1);var i=document.createElement("span");o.surroundContents(i);var l=i.getBoundingClientRect(),h=t.getBoundingClientRect(),f=document.createElement("span");t.appendChild(f),f.style.left=100*(l.left-h.left)/h.width+"%",f.style.top=100*(l.top-h.top)/h.height+"%",f.style.width=100*l.width/h.width+"%",f.style.height=100*l.height/h.height+"%",f.classList.add("rpv-search-text-highlight"),f.setAttribute("title",e.source.trim()),w(i),c&&c({highlightEle:f,keyword:e})}}(t.keyword,e,n[r[0].spanIndex],r)}))}))}}))}},y=function(e){e&&e.length>0&&f(e)},C=function(e){i(e)},S=function(e){if(e.has(r)){var t=e.get(r);t&&m({ele:t.ele,pageIndex:r,scale:t.scale,status:t.status})}},I=function(){return 0===h.length||1===h.length&&""===h[0].source.trim()};e.useEffect((function(){if(!I()&&p.status===t.LayerRenderStatus.DidRender&&!v.current.length){var e=p.ele,n=[].slice.call(e.querySelectorAll(".rpv-core-text")).map((function(e){return e.textContent})).reduce((function(e,t,n){return e.concat(t.split("").map((function(e,t){return{char:e,charIndexInSpan:t,spanIndex:n}})))}),[{char:"",charIndexInSpan:0,spanIndex:0}]).slice(1);v.current=n}}),[h,p.status]),e.useEffect((function(){if(!I()&&p.ele&&p.status===t.LayerRenderStatus.DidRender){var e=p.ele;x(e),E(e),b()}}),[h,s,p.status,v.current]),e.useEffect((function(){I()&&p.ele&&p.status===t.LayerRenderStatus.DidRender&&x(p.ele)}),[h,p.status]);var b=function(){if(s.pageIndex===r&&p.ele&&p.status===t.LayerRenderStatus.DidRender){var e=p.ele,n=e.querySelectorAll(".rpv-search-text-highlight");if(s.matchIndex<n.length){var c=n[s.matchIndex],a=function(e,t){for(var n=e.offsetTop,r=e.offsetLeft,o=e.parentElement;o&&o!==t;)n+=o.offsetTop,r+=o.offsetLeft,o=o.parentElement;return{left:r,top:n}}(c,e),u=a.left,i=a.top,l=o.get("jumpToDestination");l&&(l(r,(e.getBoundingClientRect().height-i)/p.scale,u/p.scale,p.scale),g.current&&g.current.classList.remove("rpv-search-text-highlight-current"),g.current=c,c.classList.add("rpv-search-text-highlight-current"))}}};return e.useEffect((function(){return o.subscribe("keyword",y),o.subscribe("match",C),o.subscribe("renderStatus",S),function(){o.unsubscribe("keyword",y),o.unsubscribe("match",C),o.unsubscribe("renderStatus",S)}}),[]),e.createElement(e.Fragment,null)};exports.NextIcon=n,exports.PreviousIcon=r,exports.SearchIcon=o,exports.searchPlugin=function(n){var r=e.useMemo((function(){return n&&n.onHighlightKeyword?n.onHighlightKeyword:function(){}}),[]),o=e.useMemo((function(){return t.createStore({renderStatus:new Map})}),[]),u=l(o),i=u.clearKeyword,h=u.jumpToNextMatch,d=u.jumpToPreviousMatch,p=u.searchFor,m=u.setKeywords,g=function(t){return e.createElement(E,c({},t,{store:o}))};return{install:function(e){var t=n&&n.keyword?function(e){return Array.isArray(e)?e.map((function(e){return s(e)})):[s(e)]}(n.keyword):[a];o.update("jumpToDestination",e.jumpToDestination),o.update("jumpToPage",e.jumpToPage),o.update("keyword",t)},renderViewer:function(t){var n=t.slot;return n.subSlot&&(n.subSlot.children=e.createElement(e.Fragment,null,Array(t.doc.numPages).fill(0).map((function(t,n){return e.createElement(C,{key:n,pageIndex:n,store:o,onHighlightKeyword:r})})),n.subSlot.children)),n},uninstall:function(e){var t=o.get("renderStatus");t&&t.clear()},onDocumentLoad:function(e){o.update("doc",e.doc)},onTextLayerRender:function(e){var t=o.get("renderStatus");t&&(t=t.set(e.pageIndex,e),o.update("renderStatus",t))},Search:function(t){return e.createElement(f,c({},t,{store:o}))},ShowSearchPopover:g,ShowSearchPopoverButton:function(){return e.createElement(g,null,(function(t){return e.createElement(v,c({},t))}))},clearHighlights:function(){i()},highlight:function(e){var t=Array.isArray(e)?e:[e];m(t),p(t)},jumpToNextMatch:h,jumpToPreviousMatch:d}};
