{"ast":null,"code":"import _toConsumableArray from\"C:\\\\project\\\\SCF-NI_PM_App\\\\SCF.InstallationQuality\\\\react-client\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/toConsumableArray\";import*as action from\"actions\";import*as api from\"api\";import{db}from\"js/db\";import*as schema from\"js/schema\";import{currentRefreshTime,orderActivitiesSort,templatesConverter,getNonConformityConfig}from\"js/util\";import{normalize}from\"normalizr\";import*as repo from\"js/fetch\";import store from\"js/store\";import{taskDataConversion}from\"js/util\";export var setAllDataRefreshTime=function setAllDataRefreshTime(data){return{type:\"SET_ALL_DATA_REFRESH_TIME\",payload:data};};var setRequestStatus=function setRequestStatus(name,loading){return{type:\"SET_REQUEST_STATUS\",payload:{name:name,loading:loading}};};export var closeLoading=function closeLoading(name){return setRequestStatus(name,\"loaded\");};export var openLoading=function openLoading(name){return setRequestStatus(name,\"loading\");};export var closeLoadingShowFailInfo=function closeLoadingShowFailInfo(name){return setRequestStatus(name,\"failToLoad\");};export var fetchOrders=function fetchOrders(request,type,userInfo){return function(dispatch){var auth=JSON.parse(window.localStorage.getItem(\"auth\"));var roles=auth===null||auth===void 0?void 0:auth.roles;var isSubconTLOrPE=roles.indexOf('Subcon TL')>-1||roles.indexOf('PE')>-1;var isEISV=roles.indexOf('SL')>-1;dispatch(action.openLoading(\"masterData\"));//设置loading\napi.fetchMasterData((userInfo===null||userInfo===void 0?void 0:userInfo.pNumber)?userInfo:{}).then(function(response){var _normalize=normalize(response.data,schema.masterData),entities=_normalize.entities;entities[\"nonConformityConfig\"]=getNonConformityConfig();db.cache.put({id:\"masterData\",data:entities}).then(function(){db.cache.get(\"dataRefreshTime\").then(function(cache){var datatime=cache.data;datatime[\"masterDataRefreshTime\"]=currentRefreshTime();db.cache.put({id:\"dataRefreshTime\",data:datatime}).then(function(){dispatch(action.setAllDataRefreshTime(datatime));});});});var loaded=true;isEISV&&dispatch(action.fetchTasksList(request,userInfo,loaded,dispatch)).then(function(res){var orders=_toConsumableArray(new Set(res.map(function(item){return item.orderNo;})));fetchOrdersData(request,type,userInfo,entities,orders);});isSubconTLOrPE&&fetchOrdersData(request,type,userInfo,entities);isSubconTLOrPE&&dispatch(action.fetchTasksList(request,userInfo,dispatch));}).finally(function(){db.cache.put({id:\"dataVersion\",data:\"lastVersion\"});dispatch(action.closeLoading(\"masterData\"));}).catch(function(error){dispatch(action.closeLoadingShowFailInfo(\"masterData\"));dispatch(action.setError(error.message));return false;});};};export var fetchDocuments=function fetchDocuments(request,userInfo){return function(dispatch){dispatch(action.openLoading(\"document\"));//设置loading\napi.getDocumentList(request).then(function(response){return db.cache.put({id:\"documentList\",data:response.data}).then(function(){db.cache.get(\"dataRefreshTime\").then(function(cache){var datatime=cache.data;datatime[\"documentListDataRefreshTime\"]=currentRefreshTime();db.cache.put({id:\"dataRefreshTime\",data:datatime}).then(function(){dispatch(action.setAllDataRefreshTime(datatime));});});});}).finally(function(){dispatch(action.closeLoading(\"document\"));}).catch(function(error){dispatch(action.closeLoadingShowFailInfo(\"document\"));dispatch(action.setError(error.message));return false;});dispatch(action.openLoading(\"templateList\"));//设置loading\napi.fetchTemplatesData((userInfo===null||userInfo===void 0?void 0:userInfo.pNumber)?userInfo:{}).then(function(response){var data=templatesConverter(response.data);db.cache.put({id:\"templatesData\",data:data}).then(function(){db.cache.get(\"dataRefreshTime\").then(function(cache){var datatime=cache.data;datatime[\"templateListDataRefreshTime\"]=currentRefreshTime();db.cache.put({id:\"dataRefreshTime\",data:datatime}).then(function(){dispatch(action.setAllDataRefreshTime(datatime));});});});}).finally(function(){dispatch(action.closeLoading(\"templateList\"));}).catch(function(error){dispatch(action.closeLoadingShowFailInfo(\"templateList\"));dispatch(action.setError(error.message));return false;});};};export var fetchTasksList=function fetchTasksList(request,userInfo,loaded){return function(dispatch){dispatch(action.openLoading(\"taskList\"));//设置loading\nvar auth=JSON.parse(window.localStorage.getItem(\"auth\"));return api.fetchIDPTTasks(auth===null||auth===void 0?void 0:auth.userName).then(function(response){var _response$data;var resp=(_response$data=response.data)===null||_response$data===void 0?void 0:_response$data.data.map(function(item){return taskDataConversion(item);});if((auth===null||auth===void 0?void 0:auth.roles.indexOf('SL'))>-1&&!loaded){db.cache.get(\"masterData\").then(function(cache){var orders=_toConsumableArray(new Set(resp.map(function(item){return item.orderNo;})));fetchOrdersData(request,'',userInfo,cache===null||cache===void 0?void 0:cache.data,orders);});}return db.cache.put({id:\"tasks\",data:resp}).then(function(){return db.cache.get(\"dataRefreshTime\").then(function(cache){var datatime=cache.data;datatime[\"taskListDataRefreshTime\"]=currentRefreshTime();db.cache.put({id:\"dataRefreshTime\",data:datatime}).then(function(){dispatch(action.setAllDataRefreshTime(datatime));});return resp;});});}).finally(function(){dispatch(action.closeLoading(\"taskList\"));}).catch(function(error){dispatch(action.closeLoadingShowFailInfo(\"taskList\"));dispatch(action.setError(error.message));return false;});};};export var fetchOrdersData=function fetchOrdersData(request,type,userInfo,entities,orders){var auth=JSON.parse(window.localStorage.getItem(\"auth\"));var roles=auth===null||auth===void 0?void 0:auth.roles;var isEISV=roles.indexOf('SL')>-1;var projects=entities.workCenters?Object.keys(entities.workCenters):[];var dispatch=store.dispatch;dispatch(action.openLoading(\"ordersData\"));if(isEISV){return api.fetchEISVOrdersData(orders).then(function(response){var data=response.data;data.orderActivities=orderActivitiesSort(data.orderActivities);var _normalize2=normalize(data,schema.ordersData),entities=_normalize2.entities;return db.cache.put({id:\"ordersData\",data:entities}).then(function(){type===\"all\"&&dispatch(action.fetchDocuments(request,userInfo,dispatch));return entities;});}).finally(function(){dispatch(action.closeLoading(\"ordersData\"));}).catch(function(error){dispatch(action.closeLoadingShowFailInfo(\"ordersData\"));dispatch(action.setError(error.message));return false;});}else{api.fetchOrdersDataByProjectsAndMerge(projects,1,userInfo).then(function(response){var data=response;data.orderActivities=orderActivitiesSort(data.orderActivities);var _normalize3=normalize(response,schema.ordersData),entities=_normalize3.entities;db.cache.put({id:\"ordersData\",data:entities}).then(function(){var param={projectNos:projects};if(userInfo===null||userInfo===void 0?void 0:userInfo.pNumber){param[\"pNumber\"]=userInfo.pNumber;}repo.fetchLocalInstallationStepsConfirmDate(param).then(function(){db.cache.get(\"dataRefreshTime\").then(function(cache){var datatime=cache.data;datatime[\"orderDataRefreshTime\"]=currentRefreshTime();db.cache.put({id:\"dataRefreshTime\",data:datatime}).then(function(){dispatch(action.setAllDataRefreshTime(datatime));type===\"all\"&&dispatch(action.fetchDocuments(request,userInfo,dispatch));});});});});}).finally(function(){dispatch(action.closeLoading(\"ordersData\"));}).catch(function(error){dispatch(action.closeLoadingShowFailInfo(\"ordersData\"));dispatch(action.setError(error.message));return false;});}};","map":{"version":3,"sources":["C:/project/SCF-NI_PM_App/SCF.InstallationQuality/react-client/src/actions/refreshTime.js"],"names":["action","api","db","schema","currentRefreshTime","orderActivitiesSort","templatesConverter","getNonConformityConfig","normalize","repo","store","taskDataConversion","setAllDataRefreshTime","data","type","payload","setRequestStatus","name","loading","closeLoading","openLoading","closeLoadingShowFailInfo","fetchOrders","request","userInfo","dispatch","auth","JSON","parse","window","localStorage","getItem","roles","isSubconTLOrPE","indexOf","isEISV","fetchMasterData","pNumber","then","response","masterData","entities","cache","put","id","get","datatime","loaded","fetchTasksList","res","orders","Set","map","item","orderNo","fetchOrdersData","finally","catch","error","setError","message","fetchDocuments","getDocumentList","fetchTemplatesData","fetchIDPTTasks","userName","resp","projects","workCenters","Object","keys","fetchEISVOrdersData","orderActivities","ordersData","fetchOrdersDataByProjectsAndMerge","param","projectNos","fetchLocalInstallationStepsConfirmDate"],"mappings":"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","sourcesContent":["import * as action from \"actions\";\r\nimport * as api from \"api\";\r\nimport { db } from \"js/db\";\r\nimport * as schema from \"js/schema\";\r\nimport {\r\n  currentRefreshTime,\r\n  orderActivitiesSort,\r\n  templatesConverter,\r\n  getNonConformityConfig\r\n} from \"js/util\";\r\nimport { normalize } from \"normalizr\";\r\nimport * as repo from \"js/fetch\";\r\nimport store from \"js/store\";\r\nimport { taskDataConversion } from \"js/util\";\r\n\r\nexport const setAllDataRefreshTime = (data) => ({\r\n  type: \"SET_ALL_DATA_REFRESH_TIME\",\r\n  payload: data,\r\n});\r\n\r\nconst setRequestStatus = (name, loading) => {\r\n  return { type: \"SET_REQUEST_STATUS\", payload: { name, loading } };\r\n};\r\n\r\nexport const closeLoading = (name) => setRequestStatus(name, \"loaded\");\r\n\r\nexport const openLoading = (name) => setRequestStatus(name, \"loading\");\r\n\r\nexport const closeLoadingShowFailInfo = (name) =>\r\n  setRequestStatus(name, \"failToLoad\");\r\n\r\nexport const fetchOrders = (request, type, userInfo) => (dispatch) => {\r\n  const auth = JSON.parse(window.localStorage.getItem(\"auth\"));\r\n  let roles = auth?.roles;\r\n  const isSubconTLOrPE = roles.indexOf('Subcon TL') > -1 || roles.indexOf('PE') > -1;\r\n  const isEISV = roles.indexOf('SL') > -1;\r\n\r\n  dispatch(action.openLoading(\"masterData\")); //设置loading\r\n  api\r\n    .fetchMasterData(userInfo?.pNumber ? userInfo : {})\r\n    .then((response) => {\r\n      const { entities } = normalize(response.data, schema.masterData);\r\n      entities[\"nonConformityConfig\"] = getNonConformityConfig()\r\n      db.cache.put({ id: \"masterData\", data: entities }).then(() => {\r\n        db.cache.get(\"dataRefreshTime\").then((cache) => {\r\n          const datatime = cache.data;\r\n          datatime[\"masterDataRefreshTime\"] = currentRefreshTime();\r\n          db.cache.put({ id: \"dataRefreshTime\", data: datatime }).then(() => {\r\n            dispatch(action.setAllDataRefreshTime(datatime));\r\n          });\r\n        });\r\n      });\r\n\r\n      let loaded = true;\r\n      isEISV && dispatch(action.fetchTasksList(request, userInfo, loaded, dispatch)).then((res) => {\r\n        let orders = [...new Set(res.map(item => item.orderNo))]\r\n        fetchOrdersData(request, type, userInfo, entities, orders)\r\n      }) \r\n\r\n      isSubconTLOrPE && fetchOrdersData(request, type, userInfo, entities);\r\n\r\n      isSubconTLOrPE && dispatch(action.fetchTasksList(request,userInfo, dispatch));\r\n\r\n    })\r\n    .finally(() => {\r\n      db.cache.put({ id: \"dataVersion\", data: \"lastVersion\" })\r\n      dispatch(action.closeLoading(\"masterData\"));\r\n    })\r\n    .catch((error) => {\r\n      dispatch(action.closeLoadingShowFailInfo(\"masterData\"));\r\n      dispatch(action.setError(error.message));\r\n      return false;\r\n    });\r\n};\r\n\r\nexport const fetchDocuments = (request, userInfo) => (dispatch) => {\r\n  dispatch(action.openLoading(\"document\")); //设置loading\r\n  api\r\n    .getDocumentList(request)\r\n    .then((response) => {\r\n      return db.cache\r\n        .put({ id: \"documentList\", data: response.data })\r\n        .then(() => {\r\n          db.cache.get(\"dataRefreshTime\").then((cache) => {\r\n            const datatime = cache.data;\r\n            datatime[\"documentListDataRefreshTime\"] = currentRefreshTime();\r\n            db.cache.put({ id: \"dataRefreshTime\", data: datatime }).then(() => {\r\n              dispatch(action.setAllDataRefreshTime(datatime));\r\n            });\r\n          });\r\n        });\r\n    })\r\n    .finally(() => {\r\n      dispatch(action.closeLoading(\"document\"));\r\n    })\r\n    .catch((error) => {\r\n      dispatch(action.closeLoadingShowFailInfo(\"document\"));\r\n      dispatch(action.setError(error.message));\r\n      return false;\r\n    });\r\n\r\n  dispatch(action.openLoading(\"templateList\")); //设置loading\r\n  api\r\n    .fetchTemplatesData(userInfo?.pNumber ? userInfo : {})\r\n    .then((response) => {\r\n      const data = templatesConverter(response.data);\r\n      db.cache.put({ id: \"templatesData\", data: data }).then(() => {\r\n        db.cache.get(\"dataRefreshTime\").then((cache) => {\r\n          const datatime = cache.data;\r\n          datatime[\"templateListDataRefreshTime\"] = currentRefreshTime();\r\n          db.cache.put({ id: \"dataRefreshTime\", data: datatime }).then(() => {\r\n            dispatch(action.setAllDataRefreshTime(datatime));\r\n          });\r\n        });\r\n      });\r\n    })\r\n\r\n    .finally(() => {\r\n      dispatch(action.closeLoading(\"templateList\"));\r\n    })\r\n    .catch((error) => {\r\n      dispatch(action.closeLoadingShowFailInfo(\"templateList\"));\r\n      dispatch(action.setError(error.message));\r\n      return false;\r\n    });\r\n};\r\n\r\nexport const fetchTasksList = (request, userInfo, loaded) => (dispatch) => {\r\n  dispatch(action.openLoading(\"taskList\")); //设置loading\r\n  const auth = JSON.parse(window.localStorage.getItem(\"auth\"));\r\n  return api\r\n   .fetchIDPTTasks(auth?.userName)\r\n    .then((response) => {\r\n      let resp = response.data?.data.map((item) => {\r\n        return taskDataConversion(item)\r\n     })\r\n      if (auth?.roles.indexOf('SL') > -1 && !loaded) {\r\n        db.cache.get(\"masterData\").then((cache) => {\r\n          let orders = [...new Set(resp.map(item => item.orderNo))]\r\n          fetchOrdersData(request, '', userInfo, cache?.data, orders)\r\n        })\r\n      }\r\n\r\n     return db.cache.put({ id: \"tasks\", data: resp }).then(() => {\r\n       return  db.cache.get(\"dataRefreshTime\").then((cache) => {\r\n          const datatime = cache.data;\r\n          datatime[\"taskListDataRefreshTime\"] = currentRefreshTime();\r\n          db.cache.put({ id: \"dataRefreshTime\", data: datatime }).then(() => {\r\n            dispatch(action.setAllDataRefreshTime(datatime));\r\n          });\r\n         return resp\r\n        });\r\n      });\r\n    })\r\n    .finally(() => {\r\n      dispatch(action.closeLoading(\"taskList\"));\r\n    })\r\n    .catch((error) => {\r\n      dispatch(action.closeLoadingShowFailInfo(\"taskList\"));\r\n      dispatch(action.setError(error.message));\r\n      return false;\r\n    });\r\n};\r\n\r\n\r\nexport const fetchOrdersData = (request, type, userInfo, entities, orders) => {\r\n  const auth = JSON.parse(window.localStorage.getItem(\"auth\"));\r\n  let roles = auth?.roles;\r\n  const isEISV = roles.indexOf('SL') > -1;\r\n  let projects = entities.workCenters\r\n    ? Object.keys(entities.workCenters)\r\n    : [];\r\n  const dispatch = store.dispatch;\r\n  dispatch(action.openLoading(\"ordersData\"));\r\n  if (isEISV) {\r\n    return api.fetchEISVOrdersData(orders).then((response) => {\r\n      const data = response.data;\r\n      data.orderActivities = orderActivitiesSort(data.orderActivities);\r\n      const { entities } = normalize(data, schema.ordersData);\r\n      return db.cache.put({ id: \"ordersData\", data: entities }).then(() => { \r\n        type === \"all\" &&\r\n          dispatch(action.fetchDocuments(request, userInfo, dispatch));\r\n        return entities     \r\n      })\r\n    }).finally(() => {\r\n        dispatch(action.closeLoading(\"ordersData\"));\r\n    }).catch((error) => {\r\n      dispatch(action.closeLoadingShowFailInfo(\"ordersData\"));\r\n      dispatch(action.setError(error.message));\r\n      return false;\r\n    })\r\n    \r\n  } else {\r\n    api\r\n      .fetchOrdersDataByProjectsAndMerge(projects, 1, userInfo)\r\n      .then((response) => {\r\n        const data = response;\r\n        data.orderActivities = orderActivitiesSort(data.orderActivities);\r\n        const { entities } = normalize(response, schema.ordersData);\r\n        db.cache.put({ id: \"ordersData\", data: entities }).then(() => {\r\n          const param = { projectNos: projects }\r\n          if (userInfo?.pNumber) {\r\n            param[\"pNumber\"] = userInfo.pNumber\r\n          }\r\n          repo\r\n            .fetchLocalInstallationStepsConfirmDate(param)\r\n            .then(() => {\r\n              db.cache.get(\"dataRefreshTime\").then((cache) => {\r\n                const datatime = cache.data;\r\n                datatime[\"orderDataRefreshTime\"] = currentRefreshTime();\r\n                db.cache\r\n                  .put({ id: \"dataRefreshTime\", data: datatime })\r\n                  .then(() => {\r\n                    dispatch(action.setAllDataRefreshTime(datatime));\r\n                    type === \"all\" &&\r\n                      dispatch(action.fetchDocuments(request, userInfo, dispatch));\r\n                  });\r\n              });\r\n            });\r\n        });\r\n      })\r\n      .finally(() => {\r\n        dispatch(action.closeLoading(\"ordersData\"));\r\n      })\r\n      .catch((error) => {\r\n        dispatch(action.closeLoadingShowFailInfo(\"ordersData\"));\r\n        dispatch(action.setError(error.message));\r\n        return false;\r\n      });\r\n  }\r\n\r\n}\r\n\r\n\r\n  \r\n\r\n"]},"metadata":{},"sourceType":"module"}