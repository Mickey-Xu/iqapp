{"ast":null,"code":"import assert from\"assert\";import{SFDL_VERSION,XSD_VERSION,RETURN_TO_APP_URLS,DEFAULT_LANG}from\"./constants/global\";import FieldTypes from\"./constants/FieldTypes\";import{appendChild,appendVisRules,appendImages,appendTagRules,appendPrintTagRules//   appendAuthorizationRules,\n,appendExtVisRules}from\"./utils/xml\";import isValidIdentifier,{removeXMLInvalidChars}from\"./expr/isValidIdentifier\";import{encrypt}from\"./utils/crypto\";import _ from\"lodash\";import uuid from\"node-uuid\";import setupIO from\"./setup\";function buildSfdl(doc,formMetaData,fields){if(!formMetaData.settings.status){formMetaData.settings.status=\"unknown\";}var form=doc.createElement(\"form\");doc.appendChild(form);form.setAttribute(\"version\",SFDL_VERSION);form.setAttribute(\"identifier\",formMetaData.settings.identifier);form.setAttribute(\"status\",formMetaData.settings.status);form.setAttribute(\"global-template\",formMetaData.settings.globalTemplate!==undefined?formMetaData.settings.globalTemplate:\"0\");form.setAttribute(\"include-geo-location\",formMetaData.settings.includeGeoLocation);form.setAttribute(\"send-once\",formMetaData.settings.sendOnce);form.setAttribute(\"force-save-multi-language\",formMetaData.settings.forceSaveMultiLanguage);form.setAttribute(\"template-version\",formMetaData.settings.globalTemplate===\"1\"?formMetaData.templateVersion:\"\");form.setAttribute(\"instance-id\",\"\");form.setAttribute(\"geo-location\",\"\");form.setAttribute(\"template-guid\",formMetaData.id);form.setAttribute(\"xsd-version\",XSD_VERSION);form.setAttribute(\"kg-code\",formMetaData.settings.kgCode);form.setAttribute(\"max-number-of-pictures\",formMetaData.settings.maxNumberOfPictures);buildTitleAndDescription(doc,form,formMetaData);buildLogo(doc,form,formMetaData);buildLanguages(doc,form,formMetaData);buildAuthorizationUniveerse(doc,form,formMetaData);buildTagUniverse(doc,form,formMetaData);buildPrintTagUniverse(doc,form,formMetaData);buildTagRulesInFilter(doc,form,formMetaData);buildPrintSettings(doc,form,formMetaData);buildFormActions(doc,form,formMetaData);buildFormMetadata(doc,form,formMetaData);buildBuildingBlocks(doc,form,formMetaData);var findField=function findField(id){return fields.find(function(f){return f.id===id;});};var authorizationUniverse=formMetaData.settings.authorizationUniverse;var tagUniverse=formMetaData.settings.tagUniverse;var printTagUniverse=formMetaData.settings.printTagUniverse;extractPages(fields).forEach(function(pageData){var id=pageData.id,identifier=pageData.identifier,labelI18n=pageData.labelI18n,visRules=pageData.visRules,pageFields=pageData.fields,isTitlePageEnd=pageData.isTitlePageEnd,tagRules=pageData.tagRules,printTagRules=pageData.printTagRules,externalVisRules=pageData.externalVisRules;var page=appendChild(doc,form,\"page\",null,{guid:id,identifier:identifier,\"title-page-end\":isTitlePageEnd});if(labelI18n){Object.keys(labelI18n).forEach(function(lang){if(typeof labelI18n[lang]!==\"undefined\"){appendChild(doc,page,\"title\",labelI18n[lang],{lang:lang});}});}if(visRules){appendVisRules(doc,findField,page,visRules);}if(externalVisRules){appendExtVisRules(doc,findField,page,externalVisRules);}if(tagRules){appendTagRules(doc,page,null,tagRules);}if(printTagRules){//updatePrintTagValue\nvar printTagRulesWithLatestName=printTagRules.map(function(rule){var tag=printTagUniverse.find(function(t){return t.id===rule.tagId;});return Object.assign({},rule,{tagName:tag.name});});appendPrintTagRules(doc,page,null,printTagRulesWithLatestName);}extractSections(pageFields).forEach(function(sectionData){var id=sectionData.id,identifier=sectionData.identifier,labelI18n=sectionData.labelI18n,important=sectionData.important,descriptionI18n=sectionData.descriptionI18n,visRules=sectionData.visRules,sectionFields=sectionData.fields,tagRules=sectionData.tagRules,printTagRules=sectionData.printTagRules,qrCodeReader=sectionData.qrCodeReader;var section=appendChild(doc,page,\"section\",null,{guid:id,identifier:identifier,important:important,\"qr-code-reader\":qrCodeReader});if(labelI18n){Object.keys(labelI18n).forEach(function(lang){if(typeof labelI18n[lang]!==\"undefined\"){appendChild(doc,section,\"title\",labelI18n[lang],{lang:lang});}});}if(descriptionI18n){Object.keys(descriptionI18n).forEach(function(lang){if(typeof descriptionI18n[lang]!==\"undefined\"){appendChild(doc,section,\"description\",descriptionI18n[lang],{lang:lang});}});}if(visRules){appendVisRules(doc,findField,section,visRules);}if(tagRules){appendTagRules(doc,section,null,tagRules);}if(printTagRules){//updatePrintTagValue\nvar _printTagRulesWithLatestName=printTagRules.map(function(rule){var tag=printTagUniverse.find(function(t){return t.id===rule.tagId;});return Object.assign({},rule,{tagName:tag.name});});appendPrintTagRules(doc,section,null,_printTagRulesWithLatestName);}sectionFields.forEach(buildFormField.bind(null,doc,findField,authorizationUniverse,tagUniverse,printTagUniverse,section));});});}function buildTitleAndDescription(doc,form,formMetaData){var _formMetaData$setting=formMetaData.settings,titleI18n=_formMetaData$setting.titleI18n,descriptionI18n=_formMetaData$setting.descriptionI18n;Object.keys(titleI18n).forEach(function(lang){if(typeof titleI18n[lang]!==\"undefined\"){appendChild(doc,form,\"title\",titleI18n[lang],{lang:lang});}});Object.keys(descriptionI18n).forEach(function(lang){if(typeof descriptionI18n[lang]!==\"undefined\"){appendChild(doc,form,\"description\",descriptionI18n[lang],{lang:lang});}});}function buildLogo(doc,form,formMetaData){var logos=formMetaData.settings.logos;var logosNode=appendChild(doc,form,\"logos\");appendImages(doc,logosNode,logos);}function buildLanguages(doc,form,formMetaData){var languages=appendChild(doc,form,\"languages\");formMetaData.languages.forEach(function(lang){appendChild(doc,languages,\"language\",lang,{fallback:lang===formMetaData.fallbackLang});});}function buildAuthorizationUniveerse(doc,form,formMetaData){var authorizationUniverse=appendChild(doc,form,\"authorizations\");formMetaData.settings.authorizationUniverse.map(function(authorization){return authorization.name;}).filter(function(authorization){return isValidIdentifier(authorization);}).forEach(function(authorization){return appendChild(doc,authorizationUniverse,\"authorization\",\"\",{name:authorization});});}function buildTagUniverse(doc,form,formMetaData){var tagUniverse=appendChild(doc,form,\"tags\");formMetaData.settings.tagUniverse.map(function(tag){return tag.name;}).filter(function(tag){return isValidIdentifier(tag);}).forEach(function(tag){return appendChild(doc,tagUniverse,\"tag\",\"\",{name:tag});});}function buildPrintTagUniverse(doc,form,formMetaData){var tagUniverse=appendChild(doc,form,\"print_tags\");formMetaData.settings.printTagUniverse.filter(function(tag){return isValidIdentifier(tag.name);}).forEach(function(tag){return appendChild(doc,tagUniverse,\"tag\",\"\",{name:tag.name,\"exclude-from-output\":tag.excludeFromOutput});});}function buildTagRulesInFilter(doc,form,formMetaData){var tagRulesInFilter=formMetaData.settings.tagRulesInFilter;appendChild(doc,form,\"tag_rules_in_filter\",tagRulesInFilter);}function buildPrintSettings(doc,form,formMetaData){var _formMetaData$setting2=formMetaData.settings.printSettings,printHeader=_formMetaData$setting2.printHeader,headerText=_formMetaData$setting2.headerText,printFooter=_formMetaData$setting2.printFooter,footerText=_formMetaData$setting2.footerText;var settings=appendChild(doc,form,\"print_settings\",\"\",{\"header-required\":printHeader,\"footer-required\":printFooter});appendChild(doc,settings,\"header\",headerText);appendChild(doc,settings,\"footer\",footerText);}function buildFormActions(doc,form,formMetaData){if(formMetaData.settings.emailAction.selected){var emailAction=appendChild(doc,form,\"email_action\");var attachmentType=formMetaData.settings.emailAction.attachmentType;if(!attachmentType||attachmentType.length===0){attachmentType=\"all\";}emailAction.setAttribute(\"attachment-type\",attachmentType);formMetaData.settings.emailAction.receivers.map(function(email){return email.trim();}).filter(function(email){return email!==\"\";}).forEach(appendChild.bind(null,doc,emailAction,\"receiver\"));}if(formMetaData.settings.returnToApp.selected){var appId=formMetaData.settings.returnToApp.appId.trim();if(appId!==\"\"){var returnAppAction=appendChild(doc,form,\"return_to_app_action\");appendChild(doc,returnAppAction,\"app_url\",formMetaData.settings.returnToApp.appId);}}if(formMetaData.settings.webDavAction.selected){var webDavAction=appendChild(doc,form,\"webdav_action\");[\"server\",\"path\",\"username\",\"password\"].forEach(function(key){appendChild(doc,webDavAction,key,encrypt(formMetaData.settings.webDavAction[key]));});var fileType=formMetaData.settings.webDavAction.fileType;if(!fileType||fileType.length===0){fileType=\"xml\";}appendChild(doc,webDavAction,\"file-type\",fileType);}}function buildFormMetadata(doc,form,formMetaData){var metadataNode=appendChild(doc,form,\"meta_datas\");formMetaData.settings.metadata.map(function(item){return{key:item.key.trim(),value:item.value.trim()};}).filter(function(item){return item.key!==\"\"&&item.value!==\"\";}).forEach(function(item){appendChild(doc,metadataNode,\"meta_data\",null,{key:item.key,value:item.value});});}function buildBuildingBlocks(doc,form,formMetaData){if(formMetaData.settings.blocks!==undefined){var blocksArraryNode=appendChild(doc,form,\"blocks\");formMetaData.settings.blocks.forEach(function(item){var blockNode=appendChild(doc,blocksArraryNode,\"block\",null,{guid:item.guid,identifier:item.identifier,title:item.title,src:item.src});item.fields.forEach(function(fieldGuid){appendChild(doc,blockNode,\"field\",null,{guid:fieldGuid});});});}}function extractPages(fields){// returns array of array of {label, visRules, fields}\nvar result=fields.reduce(function(acc,field){if(field.type===\"pageBreak\"){var id=field.id;var _field$settings=field.settings,identifier=_field$settings.identifier,labelI18n=_field$settings.labelI18n,visRules=_field$settings.visRules,isTitlePageEnd=_field$settings.isTitlePageEnd,tagRules=_field$settings.tagRules,printTagRules=_field$settings.printTagRules,externalVisRules=_field$settings.externalVisRules;acc.push({id:id,identifier:identifier,labelI18n:labelI18n,visRules:visRules,fields:[],isTitlePageEnd:isTitlePageEnd,tagRules:tagRules,printTagRules:printTagRules,externalVisRules:externalVisRules});return acc;}else{var currentPage=acc[acc.length-1];currentPage.fields.push(field);return acc;}},[{identifier:\"pagebreak-no-content\",labelI18n:null,visRules:[],fields:[],tagRules:[],printTagRules:[],externalVisRules:[]}]);// When fields starts with a pageBreak then our initial value for the accumulator above\n// can be removed:\nvar firstPage=result[0];if(firstPage.labelI18n===null&&firstPage.descriptionI18n===null&&firstPage.fields.length===0){result.splice(0,1);}return result;}function extractSections(fields){// returns array of {label, description, fields}\nvar result=fields.reduce(function(acc,field){if(field.type===\"sectionBreak\"){var id=field.id;var _field$settings2=field.settings,identifier=_field$settings2.identifier,labelI18n=_field$settings2.labelI18n,important=_field$settings2.important,descriptionI18n=_field$settings2.descriptionI18n,visRules=_field$settings2.visRules,tagRules=_field$settings2.tagRules,printTagRules=_field$settings2.printTagRules,qrCodeReader=_field$settings2.qrCodeReader,externalVisRules=_field$settings2.externalVisRules;acc.push({id:id,identifier:identifier,labelI18n:labelI18n,important:important,descriptionI18n:descriptionI18n,visRules:visRules,fields:[],tagRules:tagRules,printTagRules:printTagRules,qrCodeReader:qrCodeReader,externalVisRules:externalVisRules});return acc;}else{var currentSection=acc[acc.length-1];currentSection.fields.push(field);return acc;}},[{identifier:\"sectionbreak-no-content\",labelI18n:null,important:false,descriptionI18n:null,visRules:[],fields:[],tagRules:[],printTagRules:[],qrCodeReader:false,externalVisRules:[]}]);// When fields starts with a sectionBreak then our initial value for the accumulator above\n// can be removed:\nvar firstSection=result[0];if(firstSection.labelI18n===null&&firstSection.descriptionI18n===null&&firstSection.fields.length===0){result.splice(0,1);}return result;}function buildFormField(doc,findField,authorizationUniverse,tagUniverse,printTagUniverse,section,field){var serializer=_.get(FieldTypes,\"\".concat(field.type,\".io.serialize\"));if(serializer){if(field.settings.authorizationRules){field.settings.authorizationRules=field.settings.authorizationRules.map(function(rule){var authorization=authorizationUniverse.find(function(t){return t.id===rule.authorizationId;});assert(authorization);return Object.assign({},rule,{authorizationName:authorization.name});});}if(field.settings.tagRules){field.settings.tagRules=field.settings.tagRules.map(function(rule){var tag=tagUniverse.find(function(t){return t.id===rule.tagId;});assert(tag);return Object.assign({},rule,{tagName:tag.name});});}if(field.settings.printTagRules){field.settings.printTagRules=field.settings.printTagRules.map(function(rule){var tag=printTagUniverse.find(function(t){return t.id===rule.tagId;});assert(tag);return Object.assign({},rule,{tagName:tag.name});});}serializer(doc,findField,section,field);}else{throw new Error(\"No SFDL serializer found for field-type=\"+field.type);}}var defaultForm={id:uuid.v4(),languages:[DEFAULT_LANG],fallbackLang:DEFAULT_LANG,settings:{identifier:\"\",titleI18n:{English:\"Untitled Form\"},globalTemplate:\"0\",descriptionI18n:{English:\"This is a new form. Please add some fields and make it awesome!\"},includeGeoLocation:false,sendOnce:false,forceSaveMultiLanguage:false,authorizationUniverse:[],tagUniverse:[],// important: this might contain illegal/blank tags -> ignore them!\nprintTagUniverse:[],tagRulesInFilter:\"0\",emailAction:{selected:false,receivers:[]},returnToApp:{selected:false,appId:RETURN_TO_APP_URLS[0]},webDavAction:{selected:false,server:\"\",path:\"\",username:\"\",password:\"\"},metadata:[],blocks:[],// hold the building block references\nlogos:[],kgCode:\"\",maxNumberOfPictures:\"10\",printSettings:{printHeader:false,headerText:\"\",printFooter:false,footerText:\"\"}}};function removeLanguages(fieldToMap){//remove I18n texts from fields and form settings\nremoveLanguageSettings(defaultForm.settings,defaultForm.languages);fieldToMap.forEach(function(field){removeLanguageSettings(field.settings,defaultForm.languages);if(typeof field.settings.options!==\"undefined\"){field.settings.options.forEach(function(option){removeLanguageSettings(option,defaultForm.languages);});}});}function removeLanguageSettings(languageSettings,languages){Object.keys(languageSettings).forEach(function(key){if(key.endsWith(\"I18n\")&&typeof languageSettings[key]===\"object\"){Object.keys(languageSettings[key]).forEach(function(langKey){if(languages.indexOf(langKey)<0){delete languageSettings[key][langKey];}});}});}export default function serialize(data){setupIO();var formMetaData=data.form;var fields=data.fields;var needRemoveLanguages=!!data.needRemoveLanguages;// if (formMetaData.instanceId) {\n//   throw new Error(\"Cannot serialize a form that already has an instance ID!\");\n// }\nif(needRemoveLanguages){removeLanguages(fields);}var doc=document.implementation.createDocument(\"\",\"\",null);buildSfdl(doc,formMetaData,fields);var serializer=new XMLSerializer();return removeXMLInvalidChars('<?xml version=\"1.0\" encoding=\"UTF-8\"?>\\n'+serializer.serializeToString(doc));}","map":{"version":3,"sources":["C:/project/SCF-NI_PM_App/SCF.InstallationQuality/react-client/src/js/sfdl/serialize.js"],"names":["assert","SFDL_VERSION","XSD_VERSION","RETURN_TO_APP_URLS","DEFAULT_LANG","FieldTypes","appendChild","appendVisRules","appendImages","appendTagRules","appendPrintTagRules","appendExtVisRules","isValidIdentifier","removeXMLInvalidChars","encrypt","_","uuid","setupIO","buildSfdl","doc","formMetaData","fields","settings","status","form","createElement","setAttribute","identifier","globalTemplate","undefined","includeGeoLocation","sendOnce","forceSaveMultiLanguage","templateVersion","id","kgCode","maxNumberOfPictures","buildTitleAndDescription","buildLogo","buildLanguages","buildAuthorizationUniveerse","buildTagUniverse","buildPrintTagUniverse","buildTagRulesInFilter","buildPrintSettings","buildFormActions","buildFormMetadata","buildBuildingBlocks","findField","find","f","authorizationUniverse","tagUniverse","printTagUniverse","extractPages","forEach","pageData","labelI18n","visRules","pageFields","isTitlePageEnd","tagRules","printTagRules","externalVisRules","page","guid","Object","keys","lang","printTagRulesWithLatestName","map","rule","tag","t","tagId","assign","tagName","name","extractSections","sectionData","important","descriptionI18n","sectionFields","qrCodeReader","section","buildFormField","bind","titleI18n","logos","logosNode","languages","fallback","fallbackLang","authorization","filter","excludeFromOutput","tagRulesInFilter","printSettings","printHeader","headerText","printFooter","footerText","emailAction","selected","attachmentType","length","receivers","email","trim","returnToApp","appId","returnAppAction","webDavAction","key","fileType","metadataNode","metadata","item","value","blocks","blocksArraryNode","blockNode","title","src","fieldGuid","result","reduce","acc","field","type","push","currentPage","firstPage","splice","currentSection","firstSection","serializer","get","authorizationRules","authorizationId","authorizationName","Error","defaultForm","v4","English","server","path","username","password","removeLanguages","fieldToMap","removeLanguageSettings","options","option","languageSettings","endsWith","langKey","indexOf","serialize","data","needRemoveLanguages","document","implementation","createDocument","XMLSerializer","serializeToString"],"mappings":"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","sourcesContent":["import assert from \"assert\";\r\nimport {\r\n  SFDL_VERSION,\r\n  XSD_VERSION,\r\n  RETURN_TO_APP_URLS,\r\n  DEFAULT_LANG,\r\n} from \"./constants/global\";\r\nimport FieldTypes from \"./constants/FieldTypes\";\r\nimport {\r\n  appendChild,\r\n  appendVisRules,\r\n  appendImages,\r\n  appendTagRules,\r\n  appendPrintTagRules,\r\n  //   appendAuthorizationRules,\r\n  appendExtVisRules,\r\n} from \"./utils/xml\";\r\nimport isValidIdentifier, {\r\n  removeXMLInvalidChars,\r\n} from \"./expr/isValidIdentifier\";\r\nimport { encrypt } from \"./utils/crypto\";\r\nimport _ from \"lodash\";\r\nimport uuid from \"node-uuid\";\r\nimport setupIO from \"./setup\";\r\n\r\nfunction buildSfdl(doc, formMetaData, fields) {\r\n  if (!formMetaData.settings.status) {\r\n    formMetaData.settings.status = \"unknown\";\r\n  }\r\n\r\n  const form = doc.createElement(\"form\");\r\n  doc.appendChild(form);\r\n  form.setAttribute(\"version\", SFDL_VERSION);\r\n  form.setAttribute(\"identifier\", formMetaData.settings.identifier);\r\n  form.setAttribute(\"status\", formMetaData.settings.status);\r\n  form.setAttribute(\r\n    \"global-template\",\r\n    formMetaData.settings.globalTemplate !== undefined\r\n      ? formMetaData.settings.globalTemplate\r\n      : \"0\"\r\n  );\r\n  form.setAttribute(\r\n    \"include-geo-location\",\r\n    formMetaData.settings.includeGeoLocation\r\n  );\r\n  form.setAttribute(\"send-once\", formMetaData.settings.sendOnce);\r\n  form.setAttribute(\r\n    \"force-save-multi-language\",\r\n    formMetaData.settings.forceSaveMultiLanguage\r\n  );\r\n  form.setAttribute(\r\n    \"template-version\",\r\n    formMetaData.settings.globalTemplate === \"1\"\r\n      ? formMetaData.templateVersion\r\n      : \"\"\r\n  );\r\n  form.setAttribute(\"instance-id\", \"\");\r\n  form.setAttribute(\"geo-location\", \"\");\r\n  form.setAttribute(\"template-guid\", formMetaData.id);\r\n  form.setAttribute(\"xsd-version\", XSD_VERSION);\r\n  form.setAttribute(\"kg-code\", formMetaData.settings.kgCode);\r\n  form.setAttribute(\r\n    \"max-number-of-pictures\",\r\n    formMetaData.settings.maxNumberOfPictures\r\n  );\r\n\r\n  buildTitleAndDescription(doc, form, formMetaData);\r\n  buildLogo(doc, form, formMetaData);\r\n  buildLanguages(doc, form, formMetaData);\r\n  buildAuthorizationUniveerse(doc, form, formMetaData);\r\n  buildTagUniverse(doc, form, formMetaData);\r\n  buildPrintTagUniverse(doc, form, formMetaData);\r\n  buildTagRulesInFilter(doc, form, formMetaData);\r\n  buildPrintSettings(doc, form, formMetaData);\r\n  buildFormActions(doc, form, formMetaData);\r\n  buildFormMetadata(doc, form, formMetaData);\r\n  buildBuildingBlocks(doc, form, formMetaData);\r\n\r\n  const findField = (id) => fields.find((f) => f.id === id);\r\n  const authorizationUniverse = formMetaData.settings.authorizationUniverse;\r\n  const tagUniverse = formMetaData.settings.tagUniverse;\r\n  const printTagUniverse = formMetaData.settings.printTagUniverse;\r\n\r\n  extractPages(fields).forEach((pageData) => {\r\n    const {\r\n      id,\r\n      identifier,\r\n      labelI18n,\r\n      visRules,\r\n      fields: pageFields,\r\n      isTitlePageEnd,\r\n      tagRules,\r\n      printTagRules,\r\n      externalVisRules,\r\n    } = pageData;\r\n    const page = appendChild(doc, form, \"page\", null, {\r\n      guid: id,\r\n      identifier: identifier,\r\n      \"title-page-end\": isTitlePageEnd,\r\n    });\r\n\r\n    if (labelI18n) {\r\n      Object.keys(labelI18n).forEach((lang) => {\r\n        if (typeof labelI18n[lang] !== \"undefined\") {\r\n          appendChild(doc, page, \"title\", labelI18n[lang], { lang });\r\n        }\r\n      });\r\n    }\r\n\r\n    if (visRules) {\r\n      appendVisRules(doc, findField, page, visRules);\r\n    }\r\n\r\n    if (externalVisRules) {\r\n      appendExtVisRules(doc, findField, page, externalVisRules);\r\n    }\r\n\r\n    if (tagRules) {\r\n      appendTagRules(doc, page, null, tagRules);\r\n    }\r\n\r\n    if (printTagRules) {\r\n      //updatePrintTagValue\r\n      let printTagRulesWithLatestName = printTagRules.map((rule) => {\r\n        const tag = printTagUniverse.find((t) => t.id === rule.tagId);\r\n        return Object.assign({}, rule, { tagName: tag.name });\r\n      });\r\n      appendPrintTagRules(doc, page, null, printTagRulesWithLatestName);\r\n    }\r\n\r\n    extractSections(pageFields).forEach((sectionData) => {\r\n      const {\r\n        id,\r\n        identifier,\r\n        labelI18n,\r\n        important,\r\n        descriptionI18n,\r\n        visRules,\r\n        fields: sectionFields,\r\n        // authorizationRules,\r\n        tagRules,\r\n        printTagRules,\r\n        qrCodeReader,\r\n      } = sectionData;\r\n      const section = appendChild(doc, page, \"section\", null, {\r\n        guid: id,\r\n        identifier: identifier,\r\n        important: important,\r\n        \"qr-code-reader\": qrCodeReader,\r\n      });\r\n\r\n      if (labelI18n) {\r\n        Object.keys(labelI18n).forEach((lang) => {\r\n          if (typeof labelI18n[lang] !== \"undefined\") {\r\n            appendChild(doc, section, \"title\", labelI18n[lang], { lang });\r\n          }\r\n        });\r\n      }\r\n\r\n      if (descriptionI18n) {\r\n        Object.keys(descriptionI18n).forEach((lang) => {\r\n          if (typeof descriptionI18n[lang] !== \"undefined\") {\r\n            appendChild(doc, section, \"description\", descriptionI18n[lang], {\r\n              lang,\r\n            });\r\n          }\r\n        });\r\n      }\r\n\r\n      if (visRules) {\r\n        appendVisRules(doc, findField, section, visRules);\r\n      }\r\n\r\n      if (tagRules) {\r\n        appendTagRules(doc, section, null, tagRules);\r\n      }\r\n\r\n      if (printTagRules) {\r\n        //updatePrintTagValue\r\n        let printTagRulesWithLatestName = printTagRules.map((rule) => {\r\n          const tag = printTagUniverse.find((t) => t.id === rule.tagId);\r\n          return Object.assign({}, rule, { tagName: tag.name });\r\n        });\r\n        appendPrintTagRules(doc, section, null, printTagRulesWithLatestName);\r\n      }\r\n\r\n      sectionFields.forEach(\r\n        buildFormField.bind(\r\n          null,\r\n          doc,\r\n          findField,\r\n          authorizationUniverse,\r\n          tagUniverse,\r\n          printTagUniverse,\r\n          section\r\n        )\r\n      );\r\n    });\r\n  });\r\n}\r\n\r\nfunction buildTitleAndDescription(doc, form, formMetaData) {\r\n  const { titleI18n, descriptionI18n } = formMetaData.settings;\r\n\r\n  Object.keys(titleI18n).forEach((lang) => {\r\n    if (typeof titleI18n[lang] !== \"undefined\") {\r\n      appendChild(doc, form, \"title\", titleI18n[lang], { lang });\r\n    }\r\n  });\r\n\r\n  Object.keys(descriptionI18n).forEach((lang) => {\r\n    if (typeof descriptionI18n[lang] !== \"undefined\") {\r\n      appendChild(doc, form, \"description\", descriptionI18n[lang], { lang });\r\n    }\r\n  });\r\n}\r\n\r\nfunction buildLogo(doc, form, formMetaData) {\r\n  const { logos } = formMetaData.settings;\r\n\r\n  const logosNode = appendChild(doc, form, \"logos\");\r\n  appendImages(doc, logosNode, logos);\r\n}\r\n\r\nfunction buildLanguages(doc, form, formMetaData) {\r\n  const languages = appendChild(doc, form, \"languages\");\r\n\r\n  formMetaData.languages.forEach((lang) => {\r\n    appendChild(doc, languages, \"language\", lang, {\r\n      fallback: lang === formMetaData.fallbackLang,\r\n    });\r\n  });\r\n}\r\n\r\nfunction buildAuthorizationUniveerse(doc, form, formMetaData) {\r\n  const authorizationUniverse = appendChild(doc, form, \"authorizations\");\r\n\r\n  formMetaData.settings.authorizationUniverse\r\n    .map((authorization) => authorization.name)\r\n    .filter((authorization) => isValidIdentifier(authorization))\r\n    .forEach((authorization) =>\r\n      appendChild(doc, authorizationUniverse, \"authorization\", \"\", {\r\n        name: authorization,\r\n      })\r\n    );\r\n}\r\n\r\nfunction buildTagUniverse(doc, form, formMetaData) {\r\n  const tagUniverse = appendChild(doc, form, \"tags\");\r\n\r\n  formMetaData.settings.tagUniverse\r\n    .map((tag) => tag.name)\r\n    .filter((tag) => isValidIdentifier(tag))\r\n    .forEach((tag) => appendChild(doc, tagUniverse, \"tag\", \"\", { name: tag }));\r\n}\r\n\r\nfunction buildPrintTagUniverse(doc, form, formMetaData) {\r\n  const tagUniverse = appendChild(doc, form, \"print_tags\");\r\n\r\n  formMetaData.settings.printTagUniverse\r\n    .filter((tag) => isValidIdentifier(tag.name))\r\n    .forEach((tag) =>\r\n      appendChild(doc, tagUniverse, \"tag\", \"\", {\r\n        name: tag.name,\r\n        \"exclude-from-output\": tag.excludeFromOutput,\r\n      })\r\n    );\r\n}\r\n\r\nfunction buildTagRulesInFilter(doc, form, formMetaData) {\r\n  const { tagRulesInFilter } = formMetaData.settings;\r\n  appendChild(doc, form, \"tag_rules_in_filter\", tagRulesInFilter);\r\n}\r\n\r\nfunction buildPrintSettings(doc, form, formMetaData) {\r\n  const {\r\n    printHeader,\r\n    headerText,\r\n    printFooter,\r\n    footerText,\r\n  } = formMetaData.settings.printSettings;\r\n\r\n  const settings = appendChild(doc, form, \"print_settings\", \"\", {\r\n    \"header-required\": printHeader,\r\n    \"footer-required\": printFooter,\r\n  });\r\n\r\n  appendChild(doc, settings, \"header\", headerText);\r\n  appendChild(doc, settings, \"footer\", footerText);\r\n}\r\n\r\nfunction buildFormActions(doc, form, formMetaData) {\r\n  if (formMetaData.settings.emailAction.selected) {\r\n    const emailAction = appendChild(doc, form, \"email_action\");\r\n\r\n    var { attachmentType } = formMetaData.settings.emailAction;\r\n    if (!attachmentType || attachmentType.length === 0) {\r\n      attachmentType = \"all\";\r\n    }\r\n\r\n    emailAction.setAttribute(\"attachment-type\", attachmentType);\r\n\r\n    formMetaData.settings.emailAction.receivers\r\n      .map((email) => email.trim())\r\n      .filter((email) => email !== \"\")\r\n      .forEach(appendChild.bind(null, doc, emailAction, \"receiver\"));\r\n  }\r\n\r\n  if (formMetaData.settings.returnToApp.selected) {\r\n    const appId = formMetaData.settings.returnToApp.appId.trim();\r\n    if (appId !== \"\") {\r\n      const returnAppAction = appendChild(doc, form, \"return_to_app_action\");\r\n      appendChild(\r\n        doc,\r\n        returnAppAction,\r\n        \"app_url\",\r\n        formMetaData.settings.returnToApp.appId\r\n      );\r\n    }\r\n  }\r\n\r\n  if (formMetaData.settings.webDavAction.selected) {\r\n    const webDavAction = appendChild(doc, form, \"webdav_action\");\r\n\r\n    [\"server\", \"path\", \"username\", \"password\"].forEach((key) => {\r\n      appendChild(\r\n        doc,\r\n        webDavAction,\r\n        key,\r\n        encrypt(formMetaData.settings.webDavAction[key])\r\n      );\r\n    });\r\n\r\n    var { fileType } = formMetaData.settings.webDavAction;\r\n    if (!fileType || fileType.length === 0) {\r\n      fileType = \"xml\";\r\n    }\r\n\r\n    appendChild(doc, webDavAction, \"file-type\", fileType);\r\n  }\r\n}\r\n\r\nfunction buildFormMetadata(doc, form, formMetaData) {\r\n  const metadataNode = appendChild(doc, form, \"meta_datas\");\r\n\r\n  formMetaData.settings.metadata\r\n    .map((item) => {\r\n      return { key: item.key.trim(), value: item.value.trim() };\r\n    })\r\n    .filter((item) => item.key !== \"\" && item.value !== \"\")\r\n    .forEach((item) => {\r\n      appendChild(doc, metadataNode, \"meta_data\", null, {\r\n        key: item.key,\r\n        value: item.value,\r\n      });\r\n    });\r\n}\r\n\r\nfunction buildBuildingBlocks(doc, form, formMetaData) {\r\n  if (formMetaData.settings.blocks !== undefined) {\r\n    const blocksArraryNode = appendChild(doc, form, \"blocks\");\r\n\r\n    formMetaData.settings.blocks.forEach((item) => {\r\n      const blockNode = appendChild(doc, blocksArraryNode, \"block\", null, {\r\n        guid: item.guid,\r\n        identifier: item.identifier,\r\n        title: item.title,\r\n        src: item.src,\r\n      });\r\n\r\n      item.fields.forEach((fieldGuid) => {\r\n        appendChild(doc, blockNode, \"field\", null, { guid: fieldGuid });\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\nfunction extractPages(fields) {\r\n  // returns array of array of {label, visRules, fields}\r\n  const result = fields.reduce(\r\n    (acc, field) => {\r\n      if (field.type === \"pageBreak\") {\r\n        const { id } = field;\r\n        const {\r\n          identifier,\r\n          labelI18n,\r\n          visRules,\r\n          isTitlePageEnd,\r\n          tagRules,\r\n          printTagRules,\r\n          externalVisRules,\r\n        } = field.settings;\r\n        acc.push({\r\n          id,\r\n          identifier,\r\n          labelI18n,\r\n          visRules,\r\n          fields: [],\r\n          isTitlePageEnd,\r\n          tagRules,\r\n          printTagRules,\r\n          externalVisRules,\r\n        });\r\n        return acc;\r\n      } else {\r\n        const currentPage = acc[acc.length - 1];\r\n        currentPage.fields.push(field);\r\n        return acc;\r\n      }\r\n    },\r\n    [\r\n      {\r\n        identifier: \"pagebreak-no-content\",\r\n        labelI18n: null,\r\n        visRules: [],\r\n        fields: [],\r\n        tagRules: [],\r\n        printTagRules: [],\r\n        externalVisRules: [],\r\n      },\r\n    ]\r\n  );\r\n\r\n  // When fields starts with a pageBreak then our initial value for the accumulator above\r\n  // can be removed:\r\n  const firstPage = result[0];\r\n  if (\r\n    firstPage.labelI18n === null &&\r\n    firstPage.descriptionI18n === null &&\r\n    firstPage.fields.length === 0\r\n  ) {\r\n    result.splice(0, 1);\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nfunction extractSections(fields) {\r\n  // returns array of {label, description, fields}\r\n  const result = fields.reduce(\r\n    (acc, field) => {\r\n      if (field.type === \"sectionBreak\") {\r\n        const { id } = field;\r\n        const {\r\n          identifier,\r\n          labelI18n,\r\n          important,\r\n          descriptionI18n,\r\n          visRules,\r\n          tagRules,\r\n          printTagRules,\r\n          qrCodeReader,\r\n          externalVisRules,\r\n        } = field.settings;\r\n        acc.push({\r\n          id,\r\n          identifier,\r\n          labelI18n,\r\n          important,\r\n          descriptionI18n,\r\n          visRules,\r\n          fields: [],\r\n          tagRules,\r\n          printTagRules,\r\n          qrCodeReader,\r\n          externalVisRules,\r\n        });\r\n        return acc;\r\n      } else {\r\n        const currentSection = acc[acc.length - 1];\r\n        currentSection.fields.push(field);\r\n        return acc;\r\n      }\r\n    },\r\n    [\r\n      {\r\n        identifier: \"sectionbreak-no-content\",\r\n        labelI18n: null,\r\n        important: false,\r\n        descriptionI18n: null,\r\n        visRules: [],\r\n        fields: [],\r\n        tagRules: [],\r\n        printTagRules: [],\r\n        qrCodeReader: false,\r\n        externalVisRules: [],\r\n      },\r\n    ]\r\n  );\r\n\r\n  // When fields starts with a sectionBreak then our initial value for the accumulator above\r\n  // can be removed:\r\n  const firstSection = result[0];\r\n  if (\r\n    firstSection.labelI18n === null &&\r\n    firstSection.descriptionI18n === null &&\r\n    firstSection.fields.length === 0\r\n  ) {\r\n    result.splice(0, 1);\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nfunction buildFormField(\r\n  doc,\r\n  findField,\r\n  authorizationUniverse,\r\n  tagUniverse,\r\n  printTagUniverse,\r\n  section,\r\n  field\r\n) {\r\n  const serializer = _.get(FieldTypes, `${field.type}.io.serialize`);\r\n  if (serializer) {\r\n    if (field.settings.authorizationRules) {\r\n      field.settings.authorizationRules = field.settings.authorizationRules.map(\r\n        (rule) => {\r\n          const authorization = authorizationUniverse.find(\r\n            (t) => t.id === rule.authorizationId\r\n          );\r\n          assert(authorization);\r\n          return Object.assign({}, rule, {\r\n            authorizationName: authorization.name,\r\n          });\r\n        }\r\n      );\r\n    }\r\n\r\n    if (field.settings.tagRules) {\r\n      field.settings.tagRules = field.settings.tagRules.map((rule) => {\r\n        const tag = tagUniverse.find((t) => t.id === rule.tagId);\r\n        assert(tag);\r\n        return Object.assign({}, rule, { tagName: tag.name });\r\n      });\r\n    }\r\n\r\n    if (field.settings.printTagRules) {\r\n      field.settings.printTagRules = field.settings.printTagRules.map(\r\n        (rule) => {\r\n          const tag = printTagUniverse.find((t) => t.id === rule.tagId);\r\n          assert(tag);\r\n          return Object.assign({}, rule, { tagName: tag.name });\r\n        }\r\n      );\r\n    }\r\n\r\n    serializer(doc, findField, section, field);\r\n  } else {\r\n    throw new Error(\"No SFDL serializer found for field-type=\" + field.type);\r\n  }\r\n}\r\n\r\nlet defaultForm = {\r\n  id: uuid.v4(),\r\n  languages: [DEFAULT_LANG],\r\n  fallbackLang: DEFAULT_LANG,\r\n  settings: {\r\n    identifier: \"\",\r\n    titleI18n: { English: \"Untitled Form\" },\r\n    globalTemplate: \"0\",\r\n    descriptionI18n: {\r\n      English:\r\n        \"This is a new form. Please add some fields and make it awesome!\",\r\n    },\r\n    includeGeoLocation: false,\r\n    sendOnce: false,\r\n    forceSaveMultiLanguage: false,\r\n    authorizationUniverse: [],\r\n    tagUniverse: [], // important: this might contain illegal/blank tags -> ignore them!\r\n    printTagUniverse: [],\r\n    tagRulesInFilter: \"0\",\r\n    emailAction: {\r\n      selected: false,\r\n      receivers: [],\r\n    },\r\n    returnToApp: {\r\n      selected: false,\r\n      appId: RETURN_TO_APP_URLS[0],\r\n    },\r\n    webDavAction: {\r\n      selected: false,\r\n      server: \"\",\r\n      path: \"\",\r\n      username: \"\",\r\n      password: \"\",\r\n    },\r\n    metadata: [],\r\n    blocks: [], // hold the building block references\r\n    logos: [],\r\n    kgCode: \"\",\r\n    maxNumberOfPictures: \"10\",\r\n    printSettings: {\r\n      printHeader: false,\r\n      headerText: \"\",\r\n      printFooter: false,\r\n      footerText: \"\",\r\n    },\r\n  },\r\n};\r\n\r\nfunction removeLanguages(fieldToMap) {\r\n  //remove I18n texts from fields and form settings\r\n  removeLanguageSettings(defaultForm.settings, defaultForm.languages);\r\n  fieldToMap.forEach(function (field) {\r\n    removeLanguageSettings(field.settings, defaultForm.languages);\r\n    if (typeof field.settings.options !== \"undefined\") {\r\n      field.settings.options.forEach((option) => {\r\n        removeLanguageSettings(option, defaultForm.languages);\r\n      });\r\n    }\r\n  });\r\n}\r\n\r\nfunction removeLanguageSettings(languageSettings, languages) {\r\n  Object.keys(languageSettings).forEach(function (key) {\r\n    if (key.endsWith(\"I18n\") && typeof languageSettings[key] === \"object\") {\r\n      Object.keys(languageSettings[key]).forEach(function (langKey) {\r\n        if (languages.indexOf(langKey) < 0) {\r\n          delete languageSettings[key][langKey];\r\n        }\r\n      });\r\n    }\r\n  });\r\n}\r\n\r\nexport default function serialize(data) {\r\n  setupIO();\r\n\r\n  const formMetaData = data.form;\r\n  const fields = data.fields;\r\n  const needRemoveLanguages = !!data.needRemoveLanguages;\r\n\r\n  // if (formMetaData.instanceId) {\r\n  //   throw new Error(\"Cannot serialize a form that already has an instance ID!\");\r\n  // }\r\n\r\n  if (needRemoveLanguages) {\r\n    removeLanguages(fields);\r\n  }\r\n\r\n  const doc = document.implementation.createDocument(\"\", \"\", null);\r\n  buildSfdl(doc, formMetaData, fields);\r\n\r\n  const serializer = new XMLSerializer();\r\n  return removeXMLInvalidChars(\r\n    '<?xml version=\"1.0\" encoding=\"UTF-8\"?>\\n' +\r\n      serializer.serializeToString(doc)\r\n  );\r\n}\r\n"]},"metadata":{},"sourceType":"module"}