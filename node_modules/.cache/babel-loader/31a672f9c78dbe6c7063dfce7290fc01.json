{"ast":null,"code":"import _toConsumableArray from\"C:\\\\project\\\\SCF-NI_PM_App\\\\SCF.InstallationQuality\\\\react-client\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/toConsumableArray\";import _defineProperty from\"C:\\\\project\\\\SCF-NI_PM_App\\\\SCF.InstallationQuality\\\\react-client\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/defineProperty\";import _slicedToArray from\"C:\\\\project\\\\SCF-NI_PM_App\\\\SCF.InstallationQuality\\\\react-client\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/slicedToArray\";import{SFDL_VERSION,SFDL_MAJOR_VERSION,SFDL_MINOR_VERSION,XSD_REVISION,XSD_VERSION,RETURN_TO_APP_URLS,DEFAULT_LANG}from\"./constants/global\";import{getRequiredAttr,getAttrWithDefault,getChildNode,getChildNodes,hasChildNode,readImages}from\"./utils/xml\";import isValidIdentifier,{removeXMLInvalidChars}from\"./expr/isValidIdentifier\";import FieldTypes from\"./constants/FieldTypes\";import uuid from\"node-uuid\";import assert from\"assert\";import{decrypt}from\"./utils/crypto\";import Ops from\"./constants/VisibilityOperators\";import moment from\"moment\";import{FREE_TEXT_VALUE}from\"./utils/options\";import getDefaultValue from\"./utils/getDefaultValue\";import setupIO from\"./setup\";export default function deserialize(xmlText){// fix cyclic call setupIO caused by recursive\nif(!arguments[1]){setupIO();}var parser=new DOMParser();var form;var fields;var fieldsVisRules;try{var docNode=parser.parseFromString(removeXMLInvalidChars(xmlText),\"application/xml\").documentElement;if(docNode.nodeName===\"form\"){checkRootNode(docNode);checkSfdlVersion(docNode,xmlText);checkXsdVersion(docNode,xmlText);form=readFormMetadata(docNode);// eslint-disable-line prefer-const\nfields=[];// eslint-disable-line prefer-const\n}else if(docNode.nodeName===\"visibility_rules\"){fieldsVisRules=[];}if(docNode.hasChildNodes()){var pageIndex=0;// XML sucks\nfor(var i=0;i<docNode.childNodes.length;i+=1){var child=docNode.childNodes[i];switch(child.nodeName){case\"title\":form.settings.titleI18n[getRequiredAttr(child,\"lang\")]=child.textContent;break;case\"description\":form.settings.descriptionI18n[getRequiredAttr(child,\"lang\")]=child.textContent;break;case\"logos\":readLogos(form,child);break;case\"authorizations\":readAuthorizationUniverse(form,child);break;case\"tags\":readTagUniverse(form,child);break;case\"print_tags\":readPrintTagUniverse(form,child);break;case\"tag_rules_in_filter\":readTagRulesInFilter(form,child);break;case\"print_settings\":readPrintSettings(form,child);break;case\"languages\":readLanguages(form,child);break;case\"email_action\":readEmailAction(form,child);break;case\"webdav_action\":readWebdavAction(form,child);break;case\"return_to_app_action\":readReturnToAppAction(form,child);break;case\"devices\":readDevices(form,child);break;case\"meta_datas\":readMetadata(form,child);break;case\"blocks\":readBuildingBlocks(form,child);break;case\"page\":readPage(fields,child,pageIndex);pageIndex+=1;break;case\"question_visibility_rules\":// addVisibilityRules(child, fieldsVisRules);\nbreak;case\"#comment\":case\"#text\":// ignore this\nbreak;default:throw new Error(\"Root element contains an illegal child element: \"+child.nodeName);}}}if(docNode.nodeName===\"form\"){// Visibility rules:\nfields.filter(function(f){return FieldTypes[f.type].initialSettings.hasOwnProperty(\"visRules\");}).forEach(function(field){field.settings.visRules=readVisRules(fields,field.node);//delete field.node;\n});// External visibility rules:\nfields.filter(function(f){return FieldTypes[f.type].initialSettings.hasOwnProperty(\"externalVisRules\");}).forEach(function(field,position){field.settings.externalVisRules=readExtVisRules(fields,field.node,position);});// Authorization rules:\nif(form.settings.authorizationUniverse===undefined){form.settings.authorizationUniverse=[];}var authorizationUniverse=form.settings.authorizationUniverse;fields.filter(function(f){return FieldTypes[f.type].initialSettings.hasOwnProperty(\"authorizationRules\");}).forEach(function(field){field.settings.authorizationRules=readAuthorizationRules(authorizationUniverse,field,field.node);//delete field.node;\n});// Tagging rules:\nvar tagUniverse=form.settings.tagUniverse;fields.filter(function(f){return FieldTypes[f.type].initialSettings.hasOwnProperty(\"tagRules\");}).forEach(function(field){field.settings.tagRules=readTagRules(tagUniverse,field,field.node);//delete field.node;\n});// Print tagging rules:\nvar printTagUniverse=form.settings.printTagUniverse;fields.filter(function(f){return FieldTypes[f.type].initialSettings.hasOwnProperty(\"printTagRules\");}).forEach(function(field){field.settings.printTagRules=readPrintTagRules(printTagUniverse,field,field.node);//delete field.node;\n});// button descriptions:\nfields.filter(function(f){return FieldTypes[f.type].initialSettings.hasOwnProperty(\"buttonDescriptions\");}).forEach(function(field){field.settings.buttonDescriptions=readButtonDescriptions(fields,field.node);//delete field.node;\n});return{form:form,fields:fields};}else{return{fieldsVisRules:fieldsVisRules};}}catch(e){return{error:e.message};}}// some browsers (Chrome, Firefox) does not throw an exception in DOMParser#parseFromString() on\n// invalid input but instead just return a document with a parsererror root-node. So check that\n// the root-node is indeed a nice form-element\nfunction checkRootNode(docNode){if(docNode.nodeName!==\"form\"&&docNode.nodeName!==\"visibility_rules\"){throw new Error(\"This doesn't even look like a valid SFDL document!\");}}function checkSfdlVersion(docNode,xmlText){var version=getRequiredAttr(docNode,\"version\");var versionParts=version.split(\".\");var major=Number(versionParts[0]);var minor=Number(versionParts[1]);if(major!==SFDL_MAJOR_VERSION||minor>SFDL_MINOR_VERSION){var stylesheet=determineTransformStylesheet(major,minor,SFDL_MAJOR_VERSION,SFDL_MINOR_VERSION);if(stylesheet){docNode=transformSfdlVersion(docNode,stylesheet,xmlText);}else{throw new Error(\"This document is in SFDL format version \".concat(version,\" but FormBuilder uses \")+\"version \".concat(SFDL_VERSION,\". Please try to upgrade the version of FormBuilder you are \")+\"using, or ask your IT-administrator to convert the form for you.\");}}}// xsd-version reflects all changes happened on the xml schema\n// while sfdl only reflects big changes\nfunction checkXsdVersion(docNode,xmlText){var xsdVersion=getAttrWithDefault(docNode,\"xsd-version\",\"\");if(xsdVersion.length===0){return;}// old version\nvar versionParts=xsdVersion.split(\".\");var major=Number(versionParts[0]);var minor=Number(versionParts[1]);var revision=Number(versionParts[2]);if(major>SFDL_MAJOR_VERSION||minor>SFDL_MINOR_VERSION||revision>XSD_REVISION){throw new Error(\"This document is in SFDL format version \".concat(xsdVersion,\" but FormBuilder uses \")+\"version \".concat(XSD_VERSION,\". Please try to upgrade the version of FormBuilder you are \")+\"using, or ask your IT-administrator to convert the form for you.\");}}function determineTransformStylesheet(sourceMajor,sourceMinor,destMajor,destMinor){var stylesheet={};stylesheet[\"xslt10to20.xslt\"]='<?xml version=\"1.0\"?><xsl:stylesheet version=\"1.0\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\"><xsl:template match=\"@title\" /><xsl:template match=\"@description\" /><xsl:template match=\"@version\" /><xsl:template match=\"@*|node()\"><xsl:copy><xsl:apply-templates select=\"@*|node()\"/></xsl:copy>  </xsl:template><xsl:template match=\"form\">  <xsl:copy><xsl:copy-of select=\"@version|@identifier|@template-version|@include-geo-location|@instance-id|@geo-location|@send-once\"/><xsl:attribute name=\"version\">2.0</xsl:attribute><xsl:choose><xsl:when test=\"not(@template-version)\"><xsl:attribute name=\"template-version\">2.0</xsl:attribute></xsl:when></xsl:choose><title lang=\"English\"><xsl:value-of select=\"@title\" /></title><description lang=\"English\"><xsl:value-of select=\"@description\" /></description><languages><language fallback=\"true\">English</language></languages><xsl:apply-templates select=\"node()\"/></xsl:copy></xsl:template><xsl:template match=\"question\"><xsl:copy> <xsl:apply-templates select=\"@*|node()\"/><description lang=\"English\"><xsl:value-of select=\"@description\" /></description></xsl:copy></xsl:template><xsl:template match=\"text\"><xsl:copy><xsl:attribute name=\"lang\">English</xsl:attribute><xsl:value-of select=\"text()\"/></xsl:copy></xsl:template><xsl:template match=\"section[@title]|section[@description]\"><xsl:copy><xsl:apply-templates select=\"@important\"/><title lang=\"English\"><xsl:value-of select=\"@title\"/></title><description lang=\"English\"><xsl:value-of select=\"@description\"/></description><xsl:apply-templates select=\"node()\"/></xsl:copy></xsl:template></xsl:stylesheet>';var key=\"xslt\"+sourceMajor+sourceMinor+\"to\"+destMajor+destMinor+\".xslt\";return stylesheet[key];}function transformSfdlVersion(docNode,stylesheet,xmlText){var parser=new DOMParser();var xsltProcessor=new XSLTProcessor();var xsltDoc=parser.parseFromString(stylesheet,\"text/xml\");xsltProcessor.importStylesheet(xsltDoc);var newDoc=xsltProcessor.transformToFragment(docNode,document);return newDoc;}function readFormMetadata(docNode){var _getAttrWithDefault$s=getAttrWithDefault(docNode,\"geo-location\",\"\").split(\",\").filter(function(s){return s!==\"\";}).map(function(s){return Number(s);}),_getAttrWithDefault$s2=_slicedToArray(_getAttrWithDefault$s,3),lat=_getAttrWithDefault$s2[0],long=_getAttrWithDefault$s2[1],latLongAccuracy=_getAttrWithDefault$s2[2];return{id:getAttrWithDefault(docNode,\"template-guid\",uuid.v4()),instanceId:getAttrWithDefault(docNode,\"instance-id\",undefined)||undefined,templateVersion:getAttrWithDefault(docNode,\"template-version\",\"1.0\"),lat:lat,long:long,latLongAccuracy:latLongAccuracy,history:[],languages:[DEFAULT_LANG],fallbackLang:DEFAULT_LANG,settings:{identifier:getRequiredAttr(docNode,\"identifier\"),xsdVersion:getAttrWithDefault(docNode,\"xsd-version\",\"\"),status:getAttrWithDefault(docNode,\"status\",\"unknown\"),globalTemplate:getAttrWithDefault(docNode,\"global-template\",\"0\"),titleI18n:_defineProperty({},DEFAULT_LANG,getAttrWithDefault(docNode,\"title\",undefined)),descriptionI18n:_defineProperty({},DEFAULT_LANG,getAttrWithDefault(docNode,\"description\",undefined)),includeGeoLocation:getRequiredAttr(docNode,\"include-geo-location\")===\"true\",sendOnce:getAttrWithDefault(docNode,\"send-once\",\"false\")===\"true\",forceSaveMultiLanguage:getAttrWithDefault(docNode,\"force-save-multi-language\",\"false\")===\"true\",tagUniverse:[],printTagUniverse:[],tagRulesInFilter:\"0\",emailAction:{selected:false,receivers:[],attachmentType:\"\"},returnToApp:{selected:false,appId:RETURN_TO_APP_URLS[0]},webDavAction:{selected:false,server:\"\",path:\"\",username:\"\",password:\"\"},metadata:[],blocks:[],logos:[],kgCode:getAttrWithDefault(docNode,\"kg-code\",\"\"),maxNumberOfPictures:getAttrWithDefault(docNode,\"max-number-of-pictures\",\"10\"),printSettings:{printHeader:false,headerText:\"\",printFooter:false,footerText:\"\"}}};}function readLogos(form,logosNode){form.settings.logos=readImages(logosNode);}function readAuthorizationUniverse(form,authorizationsNode){form.settings.authorizationUniverse=getChildNodes(authorizationsNode,\"authorization\").map(function(authorizationNode){return getRequiredAttr(authorizationNode,\"name\");}).filter(function(authorization){return isValidIdentifier(authorization);}).map(function(authorization){return{id:uuid.v4(),name:authorization};});}function readTagUniverse(form,tagsNode){form.settings.tagUniverse=getChildNodes(tagsNode,\"tag\").map(function(tagNode){return getRequiredAttr(tagNode,\"name\");}).filter(function(tag){return isValidIdentifier(tag);}).map(function(tag){return{id:uuid.v4(),name:tag};});}function readPrintTagUniverse(form,tagsNode){form.settings.printTagUniverse=getChildNodes(tagsNode,\"tag\").map(function(tagNode){return{name:getRequiredAttr(tagNode,\"name\"),excludeFromOutput:getAttrWithDefault(tagNode,\"exclude-from-output\",\"false\")===\"true\"};}).filter(function(_ref){var name=_ref.name;return isValidIdentifier(name);}).map(function(_ref2){var name=_ref2.name,excludeFromOutput=_ref2.excludeFromOutput;return{id:uuid.v4(),name:name,excludeFromOutput:excludeFromOutput};});}function readTagRulesInFilter(form,tagRulesInFilterNode){form.settings.tagRulesInFilter=tagRulesInFilterNode.textContent;}function readPrintSettings(form,printSettingsNode){var printSettings=form.settings.printSettings;printSettings.printHeader=getAttrWithDefault(printSettingsNode,\"header-required\",\"false\")===\"true\";printSettings.printFooter=getAttrWithDefault(printSettingsNode,\"footer-required\",\"false\")===\"true\";if(hasChildNode(printSettingsNode,\"header\")){var header=getChildNode(printSettingsNode,\"header\");printSettings.headerText=header.textContent;}if(hasChildNode(printSettingsNode,\"footer\")){var footer=getChildNode(printSettingsNode,\"footer\");printSettings.footerText=footer.textContent;}}function readLanguages(form,languagesNode){form.languages=getChildNodes(languagesNode,\"language\").map(function(langNode){return langNode.textContent.trim();});assert(form.languages.length>0);form.fallbackLang=getChildNodes(languagesNode,\"language\").filter(function(node){return getAttrWithDefault(node,\"fallback\",\"false\")===\"true\";}).map(function(node){return node.textContent.trim();})[0]||DEFAULT_LANG;}function readEmailAction(form,actionNode){var emailAction=form.settings.emailAction;emailAction.selected=true;emailAction.receivers=getChildNodes(actionNode,\"receiver\").map(function(node){return node.textContent;});emailAction.attachmentType=getAttrWithDefault(actionNode,\"attachment-type\",\"all\");}function readWebdavAction(form,actionNode){var webDavAction=form.settings.webDavAction;webDavAction.selected=true;[\"server\",\"path\",\"username\",\"password\"].forEach(function(attr){webDavAction[attr]=decrypt(getChildNode(actionNode,attr).textContent);});var fileType=\"\";try{fileType=getChildNode(actionNode,\"file-type\").textContent;}catch(error){console.log(error);}if(!fileType||fileType.length===0){fileType=\"xml\";}webDavAction.fileType=fileType;}function readReturnToAppAction(form,actionNode){var returnToApp=form.settings.returnToApp;returnToApp.selected=true;returnToApp.appId=getChildNode(actionNode,\"app_url\").textContent;}function readDevices(form,devicesNode){form.history=getChildNodes(devicesNode,\"device\").map(function(devNode){return{exportAction:getRequiredAttr(devNode,\"export-action\"),exportDate:new Date(getRequiredAttr(devNode,\"export-date\")),deviceId:devNode.textContent};});}function readMetadata(form,metadataNode){form.settings.metadata=getChildNodes(metadataNode,\"meta_data\").map(function(item){return{key:getRequiredAttr(item,\"key\"),value:getRequiredAttr(item,\"value\")};});}function readBuildingBlocks(form,blocksNode){form.settings.blocks=getChildNodes(blocksNode,\"block\").map(function(blockNode){return{guid:getRequiredAttr(blockNode,\"guid\"),identifier:getRequiredAttr(blockNode,\"identifier\"),title:getRequiredAttr(blockNode,\"title\"),src:getRequiredAttr(blockNode,\"src\"),fields:getChildNodes(blockNode,\"field\").map(function(fieldNode){return getRequiredAttr(fieldNode,\"guid\");})};});}function readPage(fields,pageNode,pageIndex){var pageField=null;if(pageIndex!==0||hasChildNode(pageNode,\"title\")||pageNode.hasAttribute(\"title\")){pageField={id:getAttrWithDefault(pageNode,\"guid\",uuid.v4()),type:\"pageBreak\",settings:{identifier:getAttrWithDefault(pageNode,\"identifier\",\"\"),labelI18n:_defineProperty({},DEFAULT_LANG,getAttrWithDefault(pageNode,\"title\",undefined)),isCollapsed:false,isTitlePageEnd:getAttrWithDefault(pageNode,\"title-page-end\",\"false\")===\"true\"}};fields.push(pageField);}if(pageNode.hasChildNodes()){var sectionIndex=0;for(var i=0;i<pageNode.childNodes.length;i+=1){var child=pageNode.childNodes[i];if(child.nodeName===\"#comment\"||child.nodeName===\"#text\"){continue;}// if (child.nodeName !== 'section') {\n//   throw new Error('page element contains an element that is not a section: ' +\n//       child.nodeName);\n// }\nif(child.nodeName===\"title\"){assert(pageField);pageField.settings.labelI18n[getRequiredAttr(child,\"lang\")]=child.textContent;}else if((child.nodeName===\"visibility_rules\"||child.nodeName===\"print_tag_rules\")&&child.hasChildNodes()){assert(pageField);pageField.node=pageNode;}else{readSection(fields,child,sectionIndex);sectionIndex+=1;}}}}function readSection(fields,sectionNode,sectionIndex){var sectionField=null;if(sectionIndex!==0||hasChildNode(sectionNode,\"title\")||sectionNode.hasAttribute(\"title\")||hasChildNode(sectionNode,\"description\")||sectionNode.hasAttribute(\"description\")){sectionField={id:getAttrWithDefault(sectionNode,\"guid\",uuid.v4()),type:\"sectionBreak\",settings:{identifier:getAttrWithDefault(sectionNode,\"identifier\",\"\"),labelI18n:_defineProperty({},DEFAULT_LANG,getAttrWithDefault(sectionNode,\"title\",undefined)),important:getRequiredAttr(sectionNode,\"important\")===\"true\",descriptionI18n:_defineProperty({},DEFAULT_LANG,getAttrWithDefault(sectionNode,\"description\",undefined)),isCollapsed:false,qrCodeReader:getAttrWithDefault(sectionNode,\"qr-code-reader\",\"false\")===\"true\"}};fields.push(sectionField);}if(sectionNode.hasChildNodes()){for(var i=0;i<sectionNode.childNodes.length;i+=1){var child=sectionNode.childNodes[i];if(child.nodeName===\"#text\"||child.nodeName===\"#comment\"){continue;}if(child.nodeName===\"title\"){assert(sectionField);sectionField.settings.labelI18n[getRequiredAttr(child,\"lang\")]=child.textContent;}else if(child.nodeName===\"description\"){assert(sectionField);sectionField.settings.descriptionI18n[getRequiredAttr(child,\"lang\")]=child.textContent;}else if(child.nodeName===\"visibility_rules\"||child.nodeName===\"print_tag_rules\"){assert(sectionField);sectionField.node=sectionNode;}else{readField(fields,child);}}}}// This reads a form field EXCEPT the visRules. We read those in a second pass because we need to\n// be able to find the referenced field\nfunction readField(fields,fieldNode){var types=Object.keys(FieldTypes);for(var i=0;i<types.length;i+=1){var type=types[i];var fieldIo=FieldTypes[type].io;if(fieldIo.canDeserialize(fieldNode)){var field=fieldIo.deserialize(fieldNode);field.node=fieldNode;fields.push(field);return;}}throw new Error(\"Unknown field element: \"+fieldNode.nodeName);}function readVisRules(fields,fieldNode){if(!fieldNode){return[];}if(hasChildNode(fieldNode,\"visibility_rules\")){var rulesNode=getChildNode(fieldNode,\"visibility_rules\");return parseVisRulesNode(fields,rulesNode);}else{return[];}}function parseVisRulesNode(fields,node){assert(node.nodeName===\"visibility_rules\");var positionRule=0;var op=getAttrWithDefault(node,\"operator\",\"\");var result=[];result.operator=op;if(node.hasChildNodes()){for(var i=0;i<node.childNodes.length;i+=1){var child=node.childNodes[i];switch(child.nodeName){case\"condition\":positionRule=positionRule+1;var condition=parseConditionNode(fields,child,positionRule);// condition.conjunctionOperator = condition.conjunctionOperator; // store conjuction operator to each condition\nresult.push(condition);break;case\"visibility_rules\":result.push(parseVisRulesNode(fields,child));break;case\"#comment\":// fall thru\ncase\"#text\":// ignore this\nbreak;default:throw new Error(\"visibility_rules element contains illegal child: \"+child.nodeName);}}}if(result.length<=1){result.operator=\"and\";}return result;}function parseConditionNode(fields,node,positionRule){assert(node.nodeName===\"condition\");var otherIdentifier=getRequiredAttr(node,\"field-identifier\");var otherFields=fields.filter(function(f){return f.settings.identifier===otherIdentifier;});if(otherFields.length!==1){throw new Error(\"Invalid SFDL: Form contains multiple fields with the same identifier: \"+otherIdentifier);}var otherField=otherFields[0];var operatorId=getRequiredAttr(node,\"operator\");var argType=Ops[operatorId].argType;var conjunctionOperator=getAttrWithDefault(node,\"conjunction-operator\",\"and\");var argument=convertRuleArgument(argType,getRequiredAttr(node,\"argument\"),otherField);var type=getAttrWithDefault(node,\"type\",undefined);var position=parseInt(getAttrWithDefault(node,\"positionRule\",undefined));// HACK to support opening old versions\nif(operatorId===\"isBool\"&&otherField.type===\"naYesNo\"){operatorId=\"isExtBool\";argument=String(argument);}return{id:uuid.v4(),fieldId:otherField.id,operatorId:operatorId,argument:argument,conjunctionOperator:conjunctionOperator,type:type,positionRule:position?position:positionRule,isInternal:true};}function convertRuleArgument(argType,argument,field){switch(argType){case\"bool\":return argument===\"true\";case\"extBool\":assert([\"\",\"na\",\"fixed\",\"true\",\"false\"].includes(argument));return argument;case\"date\":return moment(argument,\"YYYY-MM-DD\");case\"number\":return Number(argument);case\"optionId\":if(argument!==FREE_TEXT_VALUE){var otherOption=field.settings.options.find(function(option){return option.value===argument;});return otherOption.value;}else{return argument;}// assert(false);\n// return 42; // shut up eslint\ncase\"string\":return argument;default:throw new Error(\"Unknown visibility rule argument type: \"+argType);}}function readExtVisRules(fields,fieldNode,position){if(!fieldNode){return[];}if(hasChildNode(fieldNode,\"external_visibility_rules\")){var rulesNode=getChildNode(fieldNode,\"external_visibility_rules\");return parseExtVisRulesNode(fields,rulesNode,position);}else{return[];}}function parseExtVisRulesNode(fields,node,position){assert(node.nodeName===\"external_visibility_rules\");var positionRule=getLastPostionOfVisRules(fields,position);var op=getAttrWithDefault(node,\"operator\",\"\");var result=[];result.operator=op;if(node.hasChildNodes()){for(var i=0;i<node.childNodes.length;i+=1){var child=node.childNodes[i];switch(child.nodeName){case\"condition\":positionRule=positionRule+1;var condition=parseExtConditionNode(fields,child,positionRule);// condition.conjunctionOperator = condition.conjunctionOperator; // store conjuction operator to each condition\nresult.push(condition);break;case\"external_visibility_rules\":result.push(parseExtVisRulesNode(fields,child,position));break;case\"#comment\":// fall thru\ncase\"#text\":// ignore this\nbreak;default:throw new Error(\"external_visibility_rules element contains illegal child: \"+child.nodeName);}}}if(result.length<=1){result.operator=\"and\";}return result;}function getLastPostionOfVisRules(checkList,position){var getPositionVR=checkList[position].settings.visRules.map(function(rules){return rules.positionRule;});return Math.max.apply(Math,_toConsumableArray(getPositionVR));}function parseExtConditionNode(checkList,node,positionRule){assert(node.nodeName===\"condition\");var conditionNode=getChildNode(node,\"external_form\");var deserializeResult=deserialize(conditionNode.textContent,true);if(deserializeResult.error){var error=deserializeResult.error;throw new Error(\"external_visibility_rules error: \"+error);}var form=deserializeResult.form,fields=deserializeResult.fields;var otherIdentifier=getRequiredAttr(node,\"field-identifier\");var otherFields=fields.filter(function(f){return f.settings.identifier===otherIdentifier;});if(otherFields.length!==1){throw new Error(\"Invalid SFDL: Form contains multiple fields with the same identifier: \"+otherIdentifier);}var otherField=otherFields[0];var operatorId=getRequiredAttr(node,\"operator\");var argType=Ops[operatorId].argType;var conjunctionOperator=getAttrWithDefault(node,\"conjunction-operator\",\"and\");var argument=convertRuleArgument(argType,getRequiredAttr(node,\"argument\"),otherField);var position=parseInt(getAttrWithDefault(node,\"positionRule\",undefined));// HACK to support opening old versions\nif(operatorId===\"isBool\"&&otherField.type===\"naYesNo\"){operatorId=\"isExtBool\";argument=String(argument);}return{id:uuid.v4(),fieldId:otherField.id,operatorId:operatorId,argument:argument,conjunctionOperator:conjunctionOperator,form:form,fields:fields,positionRule:position?position:positionRule,isInternal:false};}function readAuthorizationRules(authorizationUniverse,field,fieldNode){if(fieldNode===undefined){return[];}var findAuthorizationId=function findAuthorizationId(name){var authorization=authorizationUniverse.find(function(t){return t.name===name;});return authorization.id;};if(hasChildNode(fieldNode,\"authorization_rules\")){var rulesNode=getChildNode(fieldNode,\"authorization_rules\");var alwaysAddNodes=getChildNodes(rulesNode,\"authorization\");var alwaysAddRules=alwaysAddNodes.map(function(tagNode){var authorizationName=getRequiredAttr(tagNode,\"name\");var authorizationId=findAuthorizationId(authorizationName);return{id:uuid.v4(),authorizationId:authorizationId,authorizationName:authorizationName};});return alwaysAddRules;}else{return[];}}function readTagRules(tagUniverse,field,fieldNode){if(fieldNode===undefined){return[];}var findTagId=function findTagId(name){var tag=tagUniverse.find(function(t){return t.name===name;});assert(tag);return tag.id;};if(hasChildNode(fieldNode,\"tag_rules\")){var rulesNode=getChildNode(fieldNode,\"tag_rules\");var ruleNodes=getChildNodes(rulesNode,\"tag_rule\");var alwaysAddNodes=getChildNodes(rulesNode,\"tag\");var alwaysAddRules=alwaysAddNodes.map(function(tagNode){var tagName=getRequiredAttr(tagNode,\"name\");var tagId=findTagId(tagName);var operator=FieldTypes[field.type].applicableOperators[0];return{id:uuid.v4(),tagId:tagId,operatorId:operator.id,argument:getDefaultValue(operator.argType,field),alwaysAdd:true};});var normalRules=ruleNodes.map(function(ruleNode){var tagName=getRequiredAttr(ruleNode,\"tag\");var tagId=findTagId(tagName);var operatorId=getRequiredAttr(ruleNode,\"operator\");var argType=Ops[operatorId].argType;var argument=convertRuleArgument(argType,getRequiredAttr(ruleNode,\"argument\"),field);return{id:uuid.v4(),tagId:tagId,operatorId:operatorId,argument:argument,alwaysAdd:false};});return alwaysAddRules.concat(normalRules);}else{return[];}}function readPrintTagRules(printTagUniverse,field,fieldNode){if(fieldNode===undefined){return[];}var findTagId=function findTagId(name){var tag=printTagUniverse.find(function(t){return t.name===name;});return tag.id;};if(hasChildNode(fieldNode,\"print_tag_rules\")){var rulesNode=getChildNode(fieldNode,\"print_tag_rules\");var alwaysAddNodes=getChildNodes(rulesNode,\"tag\");var alwaysAddRules=alwaysAddNodes.map(function(tagNode){var tagName=getRequiredAttr(tagNode,\"name\");var tagId=findTagId(tagName);return{id:uuid.v4(),tagId:tagId,tagName:tagName};});return alwaysAddRules;}else{return[];}}function readButtonDescriptions(fields,fieldNode){if(hasChildNode(fieldNode,\"button_descriptions\")){var buttonDescriptionsNode=getChildNode(fieldNode,\"button_descriptions\");return parseButtonDescriptionNode(fields,buttonDescriptionsNode);}else{return[];}}function parseButtonDescriptionNode(fields,node){assert(node.nodeName===\"button_descriptions\");var result=[];if(node.hasChildNodes()){for(var i=0;i<node.childNodes.length;i+=1){var child=node.childNodes[i];if(child.nodeName===\"#comment\"||child.nodeName===\"#text\"){continue;}var selectedDescriptionId=getRequiredAttr(child,\"selected-description-id\");var selectedButtonId=getRequiredAttr(child,\"selected-button-id\");if(child.nodeName===\"button_description\"){result.push({id:uuid.v4(),selectedDescriptionId:selectedDescriptionId,selectedButtonId:selectedButtonId});}else{throw new Error(\"button_descriptions element contains illegal child: \"+child.nodeName);}}}return result;}","map":{"version":3,"sources":["C:/project/SCF-NI_PM_App/SCF.InstallationQuality/react-client/src/js/sfdl/deserialize.js"],"names":["SFDL_VERSION","SFDL_MAJOR_VERSION","SFDL_MINOR_VERSION","XSD_REVISION","XSD_VERSION","RETURN_TO_APP_URLS","DEFAULT_LANG","getRequiredAttr","getAttrWithDefault","getChildNode","getChildNodes","hasChildNode","readImages","isValidIdentifier","removeXMLInvalidChars","FieldTypes","uuid","assert","decrypt","Ops","moment","FREE_TEXT_VALUE","getDefaultValue","setupIO","deserialize","xmlText","arguments","parser","DOMParser","form","fields","fieldsVisRules","docNode","parseFromString","documentElement","nodeName","checkRootNode","checkSfdlVersion","checkXsdVersion","readFormMetadata","hasChildNodes","pageIndex","i","childNodes","length","child","settings","titleI18n","textContent","descriptionI18n","readLogos","readAuthorizationUniverse","readTagUniverse","readPrintTagUniverse","readTagRulesInFilter","readPrintSettings","readLanguages","readEmailAction","readWebdavAction","readReturnToAppAction","readDevices","readMetadata","readBuildingBlocks","readPage","Error","filter","f","type","initialSettings","hasOwnProperty","forEach","field","visRules","readVisRules","node","position","externalVisRules","readExtVisRules","authorizationUniverse","undefined","authorizationRules","readAuthorizationRules","tagUniverse","tagRules","readTagRules","printTagUniverse","printTagRules","readPrintTagRules","buttonDescriptions","readButtonDescriptions","e","error","message","version","versionParts","split","major","Number","minor","stylesheet","determineTransformStylesheet","transformSfdlVersion","xsdVersion","revision","sourceMajor","sourceMinor","destMajor","destMinor","key","xsltProcessor","XSLTProcessor","xsltDoc","importStylesheet","newDoc","transformToFragment","document","s","map","lat","long","latLongAccuracy","id","v4","instanceId","templateVersion","history","languages","fallbackLang","identifier","status","globalTemplate","includeGeoLocation","sendOnce","forceSaveMultiLanguage","tagRulesInFilter","emailAction","selected","receivers","attachmentType","returnToApp","appId","webDavAction","server","path","username","password","metadata","blocks","logos","kgCode","maxNumberOfPictures","printSettings","printHeader","headerText","printFooter","footerText","logosNode","authorizationsNode","authorizationNode","authorization","name","tagsNode","tagNode","tag","excludeFromOutput","tagRulesInFilterNode","printSettingsNode","header","footer","languagesNode","langNode","trim","actionNode","attr","fileType","console","log","devicesNode","devNode","exportAction","exportDate","Date","deviceId","metadataNode","item","value","blocksNode","blockNode","guid","title","src","fieldNode","pageNode","pageField","hasAttribute","labelI18n","isCollapsed","isTitlePageEnd","push","sectionIndex","readSection","sectionNode","sectionField","important","qrCodeReader","readField","types","Object","keys","fieldIo","io","canDeserialize","rulesNode","parseVisRulesNode","positionRule","op","result","operator","condition","parseConditionNode","otherIdentifier","otherFields","otherField","operatorId","argType","conjunctionOperator","argument","convertRuleArgument","parseInt","String","fieldId","isInternal","includes","otherOption","options","find","option","parseExtVisRulesNode","getLastPostionOfVisRules","parseExtConditionNode","checkList","getPositionVR","rules","Math","max","conditionNode","deserializeResult","findAuthorizationId","t","alwaysAddNodes","alwaysAddRules","authorizationName","authorizationId","findTagId","ruleNodes","tagName","tagId","applicableOperators","alwaysAdd","normalRules","ruleNode","concat","buttonDescriptionsNode","parseButtonDescriptionNode","selectedDescriptionId","selectedButtonId"],"mappings":"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","sourcesContent":["import {\r\n  SFDL_VERSION,\r\n  SFDL_MAJOR_VERSION,\r\n  SFDL_MINOR_VERSION,\r\n  XSD_REVISION,\r\n  XSD_VERSION,\r\n  RETURN_TO_APP_URLS,\r\n  DEFAULT_LANG,\r\n} from \"./constants/global\";\r\nimport {\r\n  getRequiredAttr,\r\n  getAttrWithDefault,\r\n  getChildNode,\r\n  getChildNodes,\r\n  hasChildNode,\r\n  readImages,\r\n} from \"./utils/xml\";\r\nimport isValidIdentifier, {\r\n  removeXMLInvalidChars,\r\n} from \"./expr/isValidIdentifier\";\r\nimport FieldTypes from \"./constants/FieldTypes\";\r\nimport uuid from \"node-uuid\";\r\nimport assert from \"assert\";\r\nimport { decrypt } from \"./utils/crypto\";\r\nimport Ops from \"./constants/VisibilityOperators\";\r\nimport moment from \"moment\";\r\nimport { FREE_TEXT_VALUE } from \"./utils/options\";\r\nimport getDefaultValue from \"./utils/getDefaultValue\";\r\nimport setupIO from \"./setup\";\r\n\r\nexport default function deserialize(xmlText) {\r\n  // fix cyclic call setupIO caused by recursive\r\n  if (!arguments[1]) {\r\n    setupIO();\r\n  }\r\n\r\n  const parser = new DOMParser();\r\n  let form;\r\n  let fields;\r\n  let fieldsVisRules;\r\n\r\n  try {\r\n    const docNode = parser.parseFromString(\r\n      removeXMLInvalidChars(xmlText),\r\n      \"application/xml\"\r\n    ).documentElement;\r\n\r\n    if (docNode.nodeName === \"form\") {\r\n      checkRootNode(docNode);\r\n      checkSfdlVersion(docNode, xmlText);\r\n      checkXsdVersion(docNode, xmlText);\r\n\r\n      form = readFormMetadata(docNode); // eslint-disable-line prefer-const\r\n      fields = []; // eslint-disable-line prefer-const\r\n    } else if (docNode.nodeName === \"visibility_rules\") {\r\n      fieldsVisRules = [];\r\n    }\r\n\r\n    if (docNode.hasChildNodes()) {\r\n      let pageIndex = 0;\r\n\r\n      // XML sucks\r\n      for (let i = 0; i < docNode.childNodes.length; i += 1) {\r\n        const child = docNode.childNodes[i];\r\n        switch (child.nodeName) {\r\n          case \"title\":\r\n            form.settings.titleI18n[getRequiredAttr(child, \"lang\")] =\r\n              child.textContent;\r\n            break;\r\n          case \"description\":\r\n            form.settings.descriptionI18n[getRequiredAttr(child, \"lang\")] =\r\n              child.textContent;\r\n            break;\r\n          case \"logos\":\r\n            readLogos(form, child);\r\n            break;\r\n          case \"authorizations\":\r\n            readAuthorizationUniverse(form, child);\r\n            break;\r\n          case \"tags\":\r\n            readTagUniverse(form, child);\r\n            break;\r\n          case \"print_tags\":\r\n            readPrintTagUniverse(form, child);\r\n            break;\r\n          case \"tag_rules_in_filter\":\r\n            readTagRulesInFilter(form, child);\r\n            break;\r\n          case \"print_settings\":\r\n            readPrintSettings(form, child);\r\n            break;\r\n          case \"languages\":\r\n            readLanguages(form, child);\r\n            break;\r\n          case \"email_action\":\r\n            readEmailAction(form, child);\r\n            break;\r\n          case \"webdav_action\":\r\n            readWebdavAction(form, child);\r\n            break;\r\n          case \"return_to_app_action\":\r\n            readReturnToAppAction(form, child);\r\n            break;\r\n          case \"devices\":\r\n            readDevices(form, child);\r\n            break;\r\n          case \"meta_datas\":\r\n            readMetadata(form, child);\r\n            break;\r\n          case \"blocks\":\r\n            readBuildingBlocks(form, child);\r\n            break;\r\n          case \"page\":\r\n            readPage(fields, child, pageIndex);\r\n            pageIndex += 1;\r\n            break;\r\n          case \"question_visibility_rules\":\r\n            // addVisibilityRules(child, fieldsVisRules);\r\n            break;\r\n          case \"#comment\":\r\n          case \"#text\":\r\n            // ignore this\r\n            break;\r\n          default:\r\n            throw new Error(\r\n              \"Root element contains an illegal child element: \" +\r\n                child.nodeName\r\n            );\r\n        }\r\n      }\r\n    }\r\n\r\n    if (docNode.nodeName === \"form\") {\r\n      // Visibility rules:\r\n      fields\r\n        .filter((f) =>\r\n          FieldTypes[f.type].initialSettings.hasOwnProperty(\"visRules\")\r\n        )\r\n        .forEach((field) => {\r\n          field.settings.visRules = readVisRules(fields, field.node);\r\n          //delete field.node;\r\n        });\r\n\r\n      // External visibility rules:\r\n      fields\r\n        .filter((f) =>\r\n          FieldTypes[f.type].initialSettings.hasOwnProperty(\"externalVisRules\")\r\n        )\r\n        .forEach((field, position) => {\r\n          field.settings.externalVisRules = readExtVisRules(\r\n            fields,\r\n            field.node,\r\n            position\r\n          );\r\n        });\r\n\r\n      // Authorization rules:\r\n      if (form.settings.authorizationUniverse === undefined) {\r\n        form.settings.authorizationUniverse = [];\r\n      }\r\n      const authorizationUniverse = form.settings.authorizationUniverse;\r\n      fields\r\n        .filter((f) =>\r\n          FieldTypes[f.type].initialSettings.hasOwnProperty(\r\n            \"authorizationRules\"\r\n          )\r\n        )\r\n        .forEach((field) => {\r\n          field.settings.authorizationRules = readAuthorizationRules(\r\n            authorizationUniverse,\r\n            field,\r\n            field.node\r\n          );\r\n          //delete field.node;\r\n        });\r\n\r\n      // Tagging rules:\r\n      const tagUniverse = form.settings.tagUniverse;\r\n      fields\r\n        .filter((f) =>\r\n          FieldTypes[f.type].initialSettings.hasOwnProperty(\"tagRules\")\r\n        )\r\n        .forEach((field) => {\r\n          field.settings.tagRules = readTagRules(\r\n            tagUniverse,\r\n            field,\r\n            field.node\r\n          );\r\n          //delete field.node;\r\n        });\r\n\r\n      // Print tagging rules:\r\n      const printTagUniverse = form.settings.printTagUniverse;\r\n      fields\r\n        .filter((f) =>\r\n          FieldTypes[f.type].initialSettings.hasOwnProperty(\"printTagRules\")\r\n        )\r\n        .forEach((field) => {\r\n          field.settings.printTagRules = readPrintTagRules(\r\n            printTagUniverse,\r\n            field,\r\n            field.node\r\n          );\r\n          //delete field.node;\r\n        });\r\n\r\n      // button descriptions:\r\n      fields\r\n        .filter((f) =>\r\n          FieldTypes[f.type].initialSettings.hasOwnProperty(\r\n            \"buttonDescriptions\"\r\n          )\r\n        )\r\n        .forEach((field) => {\r\n          field.settings.buttonDescriptions = readButtonDescriptions(\r\n            fields,\r\n            field.node\r\n          );\r\n          //delete field.node;\r\n        });\r\n\r\n      return { form, fields };\r\n    } else {\r\n      return { fieldsVisRules };\r\n    }\r\n  } catch (e) {\r\n    return { error: e.message };\r\n  }\r\n}\r\n\r\n// some browsers (Chrome, Firefox) does not throw an exception in DOMParser#parseFromString() on\r\n// invalid input but instead just return a document with a parsererror root-node. So check that\r\n// the root-node is indeed a nice form-element\r\nfunction checkRootNode(docNode) {\r\n  if (docNode.nodeName !== \"form\" && docNode.nodeName !== \"visibility_rules\") {\r\n    throw new Error(\"This doesn't even look like a valid SFDL document!\");\r\n  }\r\n}\r\n\r\nfunction checkSfdlVersion(docNode, xmlText) {\r\n  const version = getRequiredAttr(docNode, \"version\");\r\n  const versionParts = version.split(\".\");\r\n  const major = Number(versionParts[0]);\r\n  const minor = Number(versionParts[1]);\r\n\r\n  if (major !== SFDL_MAJOR_VERSION || minor > SFDL_MINOR_VERSION) {\r\n    var stylesheet = determineTransformStylesheet(\r\n      major,\r\n      minor,\r\n      SFDL_MAJOR_VERSION,\r\n      SFDL_MINOR_VERSION\r\n    );\r\n\r\n    if (stylesheet) {\r\n      docNode = transformSfdlVersion(docNode, stylesheet, xmlText);\r\n    } else {\r\n      throw new Error(\r\n        `This document is in SFDL format version ${version} but FormBuilder uses ` +\r\n          `version ${SFDL_VERSION}. Please try to upgrade the version of FormBuilder you are ` +\r\n          `using, or ask your IT-administrator to convert the form for you.`\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\n// xsd-version reflects all changes happened on the xml schema\r\n// while sfdl only reflects big changes\r\nfunction checkXsdVersion(docNode, xmlText) {\r\n  const xsdVersion = getAttrWithDefault(docNode, \"xsd-version\", \"\");\r\n\r\n  if (xsdVersion.length === 0) {\r\n    return;\r\n  } // old version\r\n\r\n  const versionParts = xsdVersion.split(\".\");\r\n  const major = Number(versionParts[0]);\r\n  const minor = Number(versionParts[1]);\r\n  const revision = Number(versionParts[2]);\r\n\r\n  if (\r\n    major > SFDL_MAJOR_VERSION ||\r\n    minor > SFDL_MINOR_VERSION ||\r\n    revision > XSD_REVISION\r\n  ) {\r\n    throw new Error(\r\n      `This document is in SFDL format version ${xsdVersion} but FormBuilder uses ` +\r\n        `version ${XSD_VERSION}. Please try to upgrade the version of FormBuilder you are ` +\r\n        `using, or ask your IT-administrator to convert the form for you.`\r\n    );\r\n  }\r\n}\r\n\r\nfunction determineTransformStylesheet(\r\n  sourceMajor,\r\n  sourceMinor,\r\n  destMajor,\r\n  destMinor\r\n) {\r\n  var stylesheet = {};\r\n\r\n  stylesheet[\"xslt10to20.xslt\"] =\r\n    '<?xml version=\"1.0\"?><xsl:stylesheet version=\"1.0\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\"><xsl:template match=\"@title\" /><xsl:template match=\"@description\" /><xsl:template match=\"@version\" /><xsl:template match=\"@*|node()\"><xsl:copy><xsl:apply-templates select=\"@*|node()\"/></xsl:copy>  </xsl:template><xsl:template match=\"form\">  <xsl:copy><xsl:copy-of select=\"@version|@identifier|@template-version|@include-geo-location|@instance-id|@geo-location|@send-once\"/><xsl:attribute name=\"version\">2.0</xsl:attribute><xsl:choose><xsl:when test=\"not(@template-version)\"><xsl:attribute name=\"template-version\">2.0</xsl:attribute></xsl:when></xsl:choose><title lang=\"English\"><xsl:value-of select=\"@title\" /></title><description lang=\"English\"><xsl:value-of select=\"@description\" /></description><languages><language fallback=\"true\">English</language></languages><xsl:apply-templates select=\"node()\"/></xsl:copy></xsl:template><xsl:template match=\"question\"><xsl:copy> <xsl:apply-templates select=\"@*|node()\"/><description lang=\"English\"><xsl:value-of select=\"@description\" /></description></xsl:copy></xsl:template><xsl:template match=\"text\"><xsl:copy><xsl:attribute name=\"lang\">English</xsl:attribute><xsl:value-of select=\"text()\"/></xsl:copy></xsl:template><xsl:template match=\"section[@title]|section[@description]\"><xsl:copy><xsl:apply-templates select=\"@important\"/><title lang=\"English\"><xsl:value-of select=\"@title\"/></title><description lang=\"English\"><xsl:value-of select=\"@description\"/></description><xsl:apply-templates select=\"node()\"/></xsl:copy></xsl:template></xsl:stylesheet>';\r\n\r\n  const key =\r\n    \"xslt\" + sourceMajor + sourceMinor + \"to\" + destMajor + destMinor + \".xslt\";\r\n\r\n  return stylesheet[key];\r\n}\r\n\r\nfunction transformSfdlVersion(docNode, stylesheet, xmlText) {\r\n  const parser = new DOMParser();\r\n  const xsltProcessor = new XSLTProcessor();\r\n\r\n  var xsltDoc = parser.parseFromString(stylesheet, \"text/xml\");\r\n  xsltProcessor.importStylesheet(xsltDoc);\r\n\r\n  var newDoc = xsltProcessor.transformToFragment(docNode, document);\r\n\r\n  return newDoc;\r\n}\r\n\r\nfunction readFormMetadata(docNode) {\r\n  const [lat, long, latLongAccuracy] = getAttrWithDefault(\r\n    docNode,\r\n    \"geo-location\",\r\n    \"\"\r\n  )\r\n    .split(\",\")\r\n    .filter((s) => s !== \"\")\r\n    .map((s) => Number(s));\r\n\r\n  return {\r\n    id: getAttrWithDefault(docNode, \"template-guid\", uuid.v4()),\r\n    instanceId:\r\n      getAttrWithDefault(docNode, \"instance-id\", undefined) || undefined,\r\n    templateVersion: getAttrWithDefault(docNode, \"template-version\", \"1.0\"),\r\n    lat,\r\n    long,\r\n    latLongAccuracy,\r\n    history: [],\r\n    languages: [DEFAULT_LANG],\r\n    fallbackLang: DEFAULT_LANG,\r\n    settings: {\r\n      identifier: getRequiredAttr(docNode, \"identifier\"),\r\n      xsdVersion: getAttrWithDefault(docNode, \"xsd-version\", \"\"),\r\n      status: getAttrWithDefault(docNode, \"status\", \"unknown\"),\r\n      globalTemplate: getAttrWithDefault(docNode, \"global-template\", \"0\"),\r\n      titleI18n: {\r\n        [DEFAULT_LANG]: getAttrWithDefault(docNode, \"title\", undefined),\r\n      },\r\n      descriptionI18n: {\r\n        [DEFAULT_LANG]: getAttrWithDefault(docNode, \"description\", undefined),\r\n      },\r\n      includeGeoLocation:\r\n        getRequiredAttr(docNode, \"include-geo-location\") === \"true\",\r\n      sendOnce: getAttrWithDefault(docNode, \"send-once\", \"false\") === \"true\",\r\n      forceSaveMultiLanguage:\r\n        getAttrWithDefault(docNode, \"force-save-multi-language\", \"false\") ===\r\n        \"true\",\r\n      tagUniverse: [],\r\n      printTagUniverse: [],\r\n      tagRulesInFilter: \"0\",\r\n      emailAction: {\r\n        selected: false,\r\n        receivers: [],\r\n        attachmentType: \"\",\r\n      },\r\n      returnToApp: {\r\n        selected: false,\r\n        appId: RETURN_TO_APP_URLS[0],\r\n      },\r\n      webDavAction: {\r\n        selected: false,\r\n        server: \"\",\r\n        path: \"\",\r\n        username: \"\",\r\n        password: \"\",\r\n      },\r\n      metadata: [],\r\n      blocks: [],\r\n      logos: [],\r\n      kgCode: getAttrWithDefault(docNode, \"kg-code\", \"\"),\r\n      maxNumberOfPictures: getAttrWithDefault(\r\n        docNode,\r\n        \"max-number-of-pictures\",\r\n        \"10\"\r\n      ),\r\n      printSettings: {\r\n        printHeader: false,\r\n        headerText: \"\",\r\n        printFooter: false,\r\n        footerText: \"\",\r\n      },\r\n    },\r\n  };\r\n}\r\n\r\nfunction readLogos(form, logosNode) {\r\n  form.settings.logos = readImages(logosNode);\r\n}\r\n\r\nfunction readAuthorizationUniverse(form, authorizationsNode) {\r\n  form.settings.authorizationUniverse = getChildNodes(\r\n    authorizationsNode,\r\n    \"authorization\"\r\n  )\r\n    .map((authorizationNode) => getRequiredAttr(authorizationNode, \"name\"))\r\n    .filter((authorization) => isValidIdentifier(authorization))\r\n    .map((authorization) => ({\r\n      id: uuid.v4(),\r\n      name: authorization,\r\n    }));\r\n}\r\n\r\nfunction readTagUniverse(form, tagsNode) {\r\n  form.settings.tagUniverse = getChildNodes(tagsNode, \"tag\")\r\n    .map((tagNode) => getRequiredAttr(tagNode, \"name\"))\r\n    .filter((tag) => isValidIdentifier(tag))\r\n    .map((tag) => ({\r\n      id: uuid.v4(),\r\n      name: tag,\r\n    }));\r\n}\r\n\r\nfunction readPrintTagUniverse(form, tagsNode) {\r\n  form.settings.printTagUniverse = getChildNodes(tagsNode, \"tag\")\r\n    .map((tagNode) => ({\r\n      name: getRequiredAttr(tagNode, \"name\"),\r\n      excludeFromOutput:\r\n        getAttrWithDefault(tagNode, \"exclude-from-output\", \"false\") === \"true\",\r\n    }))\r\n    .filter(({ name }) => isValidIdentifier(name))\r\n    .map(({ name, excludeFromOutput }) => ({\r\n      id: uuid.v4(),\r\n      name: name,\r\n      excludeFromOutput: excludeFromOutput,\r\n    }));\r\n}\r\n\r\nfunction readTagRulesInFilter(form, tagRulesInFilterNode) {\r\n  form.settings.tagRulesInFilter = tagRulesInFilterNode.textContent;\r\n}\r\n\r\nfunction readPrintSettings(form, printSettingsNode) {\r\n  const { printSettings } = form.settings;\r\n\r\n  printSettings.printHeader =\r\n    getAttrWithDefault(printSettingsNode, \"header-required\", \"false\") ===\r\n    \"true\";\r\n  printSettings.printFooter =\r\n    getAttrWithDefault(printSettingsNode, \"footer-required\", \"false\") ===\r\n    \"true\";\r\n\r\n  if (hasChildNode(printSettingsNode, \"header\")) {\r\n    const header = getChildNode(printSettingsNode, \"header\");\r\n    printSettings.headerText = header.textContent;\r\n  }\r\n\r\n  if (hasChildNode(printSettingsNode, \"footer\")) {\r\n    const footer = getChildNode(printSettingsNode, \"footer\");\r\n    printSettings.footerText = footer.textContent;\r\n  }\r\n}\r\n\r\nfunction readLanguages(form, languagesNode) {\r\n  form.languages = getChildNodes(languagesNode, \"language\").map((langNode) =>\r\n    langNode.textContent.trim()\r\n  );\r\n\r\n  assert(form.languages.length > 0);\r\n\r\n  form.fallbackLang =\r\n    getChildNodes(languagesNode, \"language\")\r\n      .filter(\r\n        (node) => getAttrWithDefault(node, \"fallback\", \"false\") === \"true\"\r\n      )\r\n      .map((node) => node.textContent.trim())[0] || DEFAULT_LANG;\r\n}\r\n\r\nfunction readEmailAction(form, actionNode) {\r\n  const { emailAction } = form.settings;\r\n\r\n  emailAction.selected = true;\r\n  emailAction.receivers = getChildNodes(actionNode, \"receiver\").map(\r\n    (node) => node.textContent\r\n  );\r\n  emailAction.attachmentType = getAttrWithDefault(\r\n    actionNode,\r\n    \"attachment-type\",\r\n    \"all\"\r\n  );\r\n}\r\n\r\nfunction readWebdavAction(form, actionNode) {\r\n  const { webDavAction } = form.settings;\r\n\r\n  webDavAction.selected = true;\r\n  [\"server\", \"path\", \"username\", \"password\"].forEach((attr) => {\r\n    webDavAction[attr] = decrypt(getChildNode(actionNode, attr).textContent);\r\n  });\r\n\r\n  var fileType = \"\";\r\n  try {\r\n    fileType = getChildNode(actionNode, \"file-type\").textContent;\r\n  } catch (error) {\r\n    console.log(error);\r\n  }\r\n\r\n  if (!fileType || fileType.length === 0) {\r\n    fileType = \"xml\";\r\n  }\r\n  webDavAction.fileType = fileType;\r\n}\r\n\r\nfunction readReturnToAppAction(form, actionNode) {\r\n  const { returnToApp } = form.settings;\r\n\r\n  returnToApp.selected = true;\r\n  returnToApp.appId = getChildNode(actionNode, \"app_url\").textContent;\r\n}\r\n\r\nfunction readDevices(form, devicesNode) {\r\n  form.history = getChildNodes(devicesNode, \"device\").map((devNode) => ({\r\n    exportAction: getRequiredAttr(devNode, \"export-action\"),\r\n    exportDate: new Date(getRequiredAttr(devNode, \"export-date\")),\r\n    deviceId: devNode.textContent,\r\n  }));\r\n}\r\n\r\nfunction readMetadata(form, metadataNode) {\r\n  form.settings.metadata = getChildNodes(metadataNode, \"meta_data\").map(\r\n    (item) => {\r\n      return {\r\n        key: getRequiredAttr(item, \"key\"),\r\n        value: getRequiredAttr(item, \"value\"),\r\n      };\r\n    }\r\n  );\r\n}\r\n\r\nfunction readBuildingBlocks(form, blocksNode) {\r\n  form.settings.blocks = getChildNodes(blocksNode, \"block\").map(\r\n    (blockNode) => ({\r\n      guid: getRequiredAttr(blockNode, \"guid\"),\r\n      identifier: getRequiredAttr(blockNode, \"identifier\"),\r\n      title: getRequiredAttr(blockNode, \"title\"),\r\n      src: getRequiredAttr(blockNode, \"src\"),\r\n      fields: getChildNodes(blockNode, \"field\").map((fieldNode) =>\r\n        getRequiredAttr(fieldNode, \"guid\")\r\n      ),\r\n    })\r\n  );\r\n}\r\n\r\nfunction readPage(fields, pageNode, pageIndex) {\r\n  let pageField = null;\r\n\r\n  if (\r\n    pageIndex !== 0 ||\r\n    hasChildNode(pageNode, \"title\") ||\r\n    pageNode.hasAttribute(\"title\")\r\n  ) {\r\n    pageField = {\r\n      id: getAttrWithDefault(pageNode, \"guid\", uuid.v4()),\r\n      type: \"pageBreak\",\r\n      settings: {\r\n        identifier: getAttrWithDefault(pageNode, \"identifier\", \"\"),\r\n        labelI18n: {\r\n          [DEFAULT_LANG]: getAttrWithDefault(pageNode, \"title\", undefined),\r\n        },\r\n        isCollapsed: false,\r\n        isTitlePageEnd:\r\n          getAttrWithDefault(pageNode, \"title-page-end\", \"false\") === \"true\",\r\n      },\r\n    };\r\n\r\n    fields.push(pageField);\r\n  }\r\n\r\n  if (pageNode.hasChildNodes()) {\r\n    let sectionIndex = 0;\r\n    for (let i = 0; i < pageNode.childNodes.length; i += 1) {\r\n      const child = pageNode.childNodes[i];\r\n\r\n      if (child.nodeName === \"#comment\" || child.nodeName === \"#text\") {\r\n        continue;\r\n      }\r\n\r\n      // if (child.nodeName !== 'section') {\r\n      //   throw new Error('page element contains an element that is not a section: ' +\r\n      //       child.nodeName);\r\n      // }\r\n\r\n      if (child.nodeName === \"title\") {\r\n        assert(pageField);\r\n        pageField.settings.labelI18n[getRequiredAttr(child, \"lang\")] =\r\n          child.textContent;\r\n      } else if (\r\n        (child.nodeName === \"visibility_rules\" ||\r\n          child.nodeName === \"print_tag_rules\") &&\r\n        child.hasChildNodes()\r\n      ) {\r\n        assert(pageField);\r\n        pageField.node = pageNode;\r\n      } else {\r\n        readSection(fields, child, sectionIndex);\r\n        sectionIndex += 1;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction readSection(fields, sectionNode, sectionIndex) {\r\n  let sectionField = null;\r\n\r\n  if (\r\n    sectionIndex !== 0 ||\r\n    hasChildNode(sectionNode, \"title\") ||\r\n    sectionNode.hasAttribute(\"title\") ||\r\n    hasChildNode(sectionNode, \"description\") ||\r\n    sectionNode.hasAttribute(\"description\")\r\n  ) {\r\n    sectionField = {\r\n      id: getAttrWithDefault(sectionNode, \"guid\", uuid.v4()),\r\n      type: \"sectionBreak\",\r\n      settings: {\r\n        identifier: getAttrWithDefault(sectionNode, \"identifier\", \"\"),\r\n        labelI18n: {\r\n          [DEFAULT_LANG]: getAttrWithDefault(sectionNode, \"title\", undefined),\r\n        },\r\n        important: getRequiredAttr(sectionNode, \"important\") === \"true\",\r\n        descriptionI18n: {\r\n          [DEFAULT_LANG]: getAttrWithDefault(\r\n            sectionNode,\r\n            \"description\",\r\n            undefined\r\n          ),\r\n        },\r\n        isCollapsed: false,\r\n        qrCodeReader:\r\n          getAttrWithDefault(sectionNode, \"qr-code-reader\", \"false\") === \"true\",\r\n      },\r\n    };\r\n\r\n    fields.push(sectionField);\r\n  }\r\n\r\n  if (sectionNode.hasChildNodes()) {\r\n    for (let i = 0; i < sectionNode.childNodes.length; i += 1) {\r\n      const child = sectionNode.childNodes[i];\r\n\r\n      if (child.nodeName === \"#text\" || child.nodeName === \"#comment\") {\r\n        continue;\r\n      }\r\n\r\n      if (child.nodeName === \"title\") {\r\n        assert(sectionField);\r\n        sectionField.settings.labelI18n[getRequiredAttr(child, \"lang\")] =\r\n          child.textContent;\r\n      } else if (child.nodeName === \"description\") {\r\n        assert(sectionField);\r\n        sectionField.settings.descriptionI18n[getRequiredAttr(child, \"lang\")] =\r\n          child.textContent;\r\n      } else if (\r\n        child.nodeName === \"visibility_rules\" ||\r\n        child.nodeName === \"print_tag_rules\"\r\n      ) {\r\n        assert(sectionField);\r\n        sectionField.node = sectionNode;\r\n      } else {\r\n        readField(fields, child);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// This reads a form field EXCEPT the visRules. We read those in a second pass because we need to\r\n// be able to find the referenced field\r\nfunction readField(fields, fieldNode) {\r\n  const types = Object.keys(FieldTypes);\r\n\r\n  for (let i = 0; i < types.length; i += 1) {\r\n    const type = types[i];\r\n    const fieldIo = FieldTypes[type].io;\r\n\r\n    if (fieldIo.canDeserialize(fieldNode)) {\r\n      const field = fieldIo.deserialize(fieldNode);\r\n      field.node = fieldNode;\r\n      fields.push(field);\r\n      return;\r\n    }\r\n  }\r\n\r\n  throw new Error(\"Unknown field element: \" + fieldNode.nodeName);\r\n}\r\n\r\nfunction readVisRules(fields, fieldNode) {\r\n  if (!fieldNode) {\r\n    return [];\r\n  }\r\n\r\n  if (hasChildNode(fieldNode, \"visibility_rules\")) {\r\n    const rulesNode = getChildNode(fieldNode, \"visibility_rules\");\r\n\r\n    return parseVisRulesNode(fields, rulesNode);\r\n  } else {\r\n    return [];\r\n  }\r\n}\r\n\r\nfunction parseVisRulesNode(fields, node) {\r\n  assert(node.nodeName === \"visibility_rules\");\r\n\r\n  let positionRule = 0;\r\n  const op = getAttrWithDefault(node, \"operator\", \"\");\r\n\r\n  const result = [];\r\n  result.operator = op;\r\n\r\n  if (node.hasChildNodes()) {\r\n    for (let i = 0; i < node.childNodes.length; i += 1) {\r\n      const child = node.childNodes[i];\r\n\r\n      switch (child.nodeName) {\r\n        case \"condition\":\r\n          positionRule = positionRule + 1;\r\n          var condition = parseConditionNode(fields, child, positionRule);\r\n          // condition.conjunctionOperator = condition.conjunctionOperator; // store conjuction operator to each condition\r\n          result.push(condition);\r\n          break;\r\n        case \"visibility_rules\":\r\n          result.push(parseVisRulesNode(fields, child));\r\n          break;\r\n        case \"#comment\": // fall thru\r\n        case \"#text\":\r\n          // ignore this\r\n          break;\r\n        default:\r\n          throw new Error(\r\n            \"visibility_rules element contains illegal child: \" + child.nodeName\r\n          );\r\n      }\r\n    }\r\n  }\r\n\r\n  if (result.length <= 1) {\r\n    result.operator = \"and\";\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nfunction parseConditionNode(fields, node, positionRule) {\r\n  assert(node.nodeName === \"condition\");\r\n\r\n  const otherIdentifier = getRequiredAttr(node, \"field-identifier\");\r\n  const otherFields = fields.filter(\r\n    (f) => f.settings.identifier === otherIdentifier\r\n  );\r\n  if (otherFields.length !== 1) {\r\n    throw new Error(\r\n      \"Invalid SFDL: Form contains multiple fields with the same identifier: \" +\r\n        otherIdentifier\r\n    );\r\n  }\r\n  const otherField = otherFields[0];\r\n\r\n  let operatorId = getRequiredAttr(node, \"operator\");\r\n  const argType = Ops[operatorId].argType;\r\n\r\n  let conjunctionOperator = getAttrWithDefault(\r\n    node,\r\n    \"conjunction-operator\",\r\n    \"and\"\r\n  );\r\n  let argument = convertRuleArgument(\r\n    argType,\r\n    getRequiredAttr(node, \"argument\"),\r\n    otherField\r\n  );\r\n\r\n  let type = getAttrWithDefault(node, \"type\", undefined);\r\n\r\n  let position = parseInt(getAttrWithDefault(node, \"positionRule\", undefined));\r\n\r\n  // HACK to support opening old versions\r\n  if (operatorId === \"isBool\" && otherField.type === \"naYesNo\") {\r\n    operatorId = \"isExtBool\";\r\n    argument = String(argument);\r\n  }\r\n\r\n  return {\r\n    id: uuid.v4(),\r\n    fieldId: otherField.id,\r\n    operatorId: operatorId,\r\n    argument: argument,\r\n    conjunctionOperator: conjunctionOperator,\r\n    type: type,\r\n    positionRule: position ? position : positionRule,\r\n    isInternal: true,\r\n  };\r\n}\r\n\r\nfunction convertRuleArgument(argType, argument, field) {\r\n  switch (argType) {\r\n    case \"bool\":\r\n      return argument === \"true\";\r\n    case \"extBool\":\r\n      assert([\"\", \"na\", \"fixed\", \"true\", \"false\"].includes(argument));\r\n      return argument;\r\n    case \"date\":\r\n      return moment(argument, \"YYYY-MM-DD\");\r\n    case \"number\":\r\n      return Number(argument);\r\n    case \"optionId\":\r\n      if (argument !== FREE_TEXT_VALUE) {\r\n        const otherOption = field.settings.options.find(\r\n          (option) => option.value === argument\r\n        );\r\n        return otherOption.value;\r\n      } else {\r\n        return argument;\r\n      }\r\n    // assert(false);\r\n    // return 42; // shut up eslint\r\n    case \"string\":\r\n      return argument;\r\n    default:\r\n      throw new Error(\"Unknown visibility rule argument type: \" + argType);\r\n  }\r\n}\r\n\r\nfunction readExtVisRules(fields, fieldNode, position) {\r\n  if (!fieldNode) {\r\n    return [];\r\n  }\r\n\r\n  if (hasChildNode(fieldNode, \"external_visibility_rules\")) {\r\n    const rulesNode = getChildNode(fieldNode, \"external_visibility_rules\");\r\n\r\n    return parseExtVisRulesNode(fields, rulesNode, position);\r\n  } else {\r\n    return [];\r\n  }\r\n}\r\n\r\nfunction parseExtVisRulesNode(fields, node, position) {\r\n  assert(node.nodeName === \"external_visibility_rules\");\r\n\r\n  let positionRule = getLastPostionOfVisRules(fields, position);\r\n  const op = getAttrWithDefault(node, \"operator\", \"\");\r\n\r\n  const result = [];\r\n  result.operator = op;\r\n\r\n  if (node.hasChildNodes()) {\r\n    for (let i = 0; i < node.childNodes.length; i += 1) {\r\n      const child = node.childNodes[i];\r\n\r\n      switch (child.nodeName) {\r\n        case \"condition\":\r\n          positionRule = positionRule + 1;\r\n          var condition = parseExtConditionNode(fields, child, positionRule);\r\n          // condition.conjunctionOperator = condition.conjunctionOperator; // store conjuction operator to each condition\r\n          result.push(condition);\r\n          break;\r\n        case \"external_visibility_rules\":\r\n          result.push(parseExtVisRulesNode(fields, child, position));\r\n          break;\r\n        case \"#comment\": // fall thru\r\n        case \"#text\":\r\n          // ignore this\r\n          break;\r\n        default:\r\n          throw new Error(\r\n            \"external_visibility_rules element contains illegal child: \" +\r\n              child.nodeName\r\n          );\r\n      }\r\n    }\r\n  }\r\n\r\n  if (result.length <= 1) {\r\n    result.operator = \"and\";\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nfunction getLastPostionOfVisRules(checkList, position) {\r\n  const getPositionVR = checkList[position].settings.visRules.map((rules) => {\r\n    return rules.positionRule;\r\n  });\r\n  return Math.max(...getPositionVR);\r\n}\r\n\r\nfunction parseExtConditionNode(checkList, node, positionRule) {\r\n  assert(node.nodeName === \"condition\");\r\n\r\n  const conditionNode = getChildNode(node, \"external_form\");\r\n  const deserializeResult = deserialize(conditionNode.textContent, true);\r\n\r\n  if (deserializeResult.error) {\r\n    const { error } = deserializeResult;\r\n    throw new Error(\"external_visibility_rules error: \" + error);\r\n  }\r\n\r\n  const { form, fields } = deserializeResult;\r\n\r\n  const otherIdentifier = getRequiredAttr(node, \"field-identifier\");\r\n  const otherFields = fields.filter(\r\n    (f) => f.settings.identifier === otherIdentifier\r\n  );\r\n  if (otherFields.length !== 1) {\r\n    throw new Error(\r\n      \"Invalid SFDL: Form contains multiple fields with the same identifier: \" +\r\n        otherIdentifier\r\n    );\r\n  }\r\n  const otherField = otherFields[0];\r\n\r\n  let operatorId = getRequiredAttr(node, \"operator\");\r\n  const argType = Ops[operatorId].argType;\r\n\r\n  let conjunctionOperator = getAttrWithDefault(\r\n    node,\r\n    \"conjunction-operator\",\r\n    \"and\"\r\n  );\r\n\r\n  let argument = convertRuleArgument(\r\n    argType,\r\n    getRequiredAttr(node, \"argument\"),\r\n    otherField\r\n  );\r\n\r\n  let position = parseInt(getAttrWithDefault(node, \"positionRule\", undefined));\r\n  // HACK to support opening old versions\r\n  if (operatorId === \"isBool\" && otherField.type === \"naYesNo\") {\r\n    operatorId = \"isExtBool\";\r\n    argument = String(argument);\r\n  }\r\n\r\n  return {\r\n    id: uuid.v4(),\r\n    fieldId: otherField.id,\r\n    operatorId: operatorId,\r\n    argument: argument,\r\n    conjunctionOperator: conjunctionOperator,\r\n    form: form,\r\n    fields: fields,\r\n    positionRule: position ? position : positionRule,\r\n    isInternal: false,\r\n  };\r\n}\r\n\r\nfunction readAuthorizationRules(authorizationUniverse, field, fieldNode) {\r\n  if (fieldNode === undefined) {\r\n    return [];\r\n  }\r\n\r\n  const findAuthorizationId = (name) => {\r\n    const authorization = authorizationUniverse.find((t) => t.name === name);\r\n    return authorization.id;\r\n  };\r\n\r\n  if (hasChildNode(fieldNode, \"authorization_rules\")) {\r\n    const rulesNode = getChildNode(fieldNode, \"authorization_rules\");\r\n    const alwaysAddNodes = getChildNodes(rulesNode, \"authorization\");\r\n\r\n    const alwaysAddRules = alwaysAddNodes.map((tagNode) => {\r\n      const authorizationName = getRequiredAttr(tagNode, \"name\");\r\n      const authorizationId = findAuthorizationId(authorizationName);\r\n      return {\r\n        id: uuid.v4(),\r\n        authorizationId: authorizationId,\r\n        authorizationName: authorizationName,\r\n      };\r\n    });\r\n\r\n    return alwaysAddRules;\r\n  } else {\r\n    return [];\r\n  }\r\n}\r\n\r\nfunction readTagRules(tagUniverse, field, fieldNode) {\r\n  if (fieldNode === undefined) {\r\n    return [];\r\n  }\r\n\r\n  const findTagId = (name) => {\r\n    const tag = tagUniverse.find((t) => t.name === name);\r\n    assert(tag);\r\n    return tag.id;\r\n  };\r\n\r\n  if (hasChildNode(fieldNode, \"tag_rules\")) {\r\n    const rulesNode = getChildNode(fieldNode, \"tag_rules\");\r\n\r\n    const ruleNodes = getChildNodes(rulesNode, \"tag_rule\");\r\n    const alwaysAddNodes = getChildNodes(rulesNode, \"tag\");\r\n\r\n    const alwaysAddRules = alwaysAddNodes.map((tagNode) => {\r\n      const tagName = getRequiredAttr(tagNode, \"name\");\r\n      const tagId = findTagId(tagName);\r\n      const operator = FieldTypes[field.type].applicableOperators[0];\r\n      return {\r\n        id: uuid.v4(),\r\n        tagId: tagId,\r\n        operatorId: operator.id,\r\n        argument: getDefaultValue(operator.argType, field),\r\n        alwaysAdd: true,\r\n      };\r\n    });\r\n\r\n    const normalRules = ruleNodes.map((ruleNode) => {\r\n      const tagName = getRequiredAttr(ruleNode, \"tag\");\r\n      const tagId = findTagId(tagName);\r\n      const operatorId = getRequiredAttr(ruleNode, \"operator\");\r\n      const argType = Ops[operatorId].argType;\r\n      const argument = convertRuleArgument(\r\n        argType,\r\n        getRequiredAttr(ruleNode, \"argument\"),\r\n        field\r\n      );\r\n\r\n      return {\r\n        id: uuid.v4(),\r\n        tagId: tagId,\r\n        operatorId: operatorId,\r\n        argument: argument,\r\n        alwaysAdd: false,\r\n      };\r\n    });\r\n\r\n    return alwaysAddRules.concat(normalRules);\r\n  } else {\r\n    return [];\r\n  }\r\n}\r\n\r\nfunction readPrintTagRules(printTagUniverse, field, fieldNode) {\r\n  if (fieldNode === undefined) {\r\n    return [];\r\n  }\r\n\r\n  const findTagId = (name) => {\r\n    const tag = printTagUniverse.find((t) => t.name === name);\r\n    return tag.id;\r\n  };\r\n\r\n  if (hasChildNode(fieldNode, \"print_tag_rules\")) {\r\n    const rulesNode = getChildNode(fieldNode, \"print_tag_rules\");\r\n    const alwaysAddNodes = getChildNodes(rulesNode, \"tag\");\r\n\r\n    const alwaysAddRules = alwaysAddNodes.map((tagNode) => {\r\n      const tagName = getRequiredAttr(tagNode, \"name\");\r\n      const tagId = findTagId(tagName);\r\n      return {\r\n        id: uuid.v4(),\r\n        tagId: tagId,\r\n        tagName: tagName,\r\n      };\r\n    });\r\n\r\n    return alwaysAddRules;\r\n  } else {\r\n    return [];\r\n  }\r\n}\r\n\r\nfunction readButtonDescriptions(fields, fieldNode) {\r\n  if (hasChildNode(fieldNode, \"button_descriptions\")) {\r\n    const buttonDescriptionsNode = getChildNode(\r\n      fieldNode,\r\n      \"button_descriptions\"\r\n    );\r\n\r\n    return parseButtonDescriptionNode(fields, buttonDescriptionsNode);\r\n  } else {\r\n    return [];\r\n  }\r\n}\r\n\r\nfunction parseButtonDescriptionNode(fields, node) {\r\n  assert(node.nodeName === \"button_descriptions\");\r\n\r\n  const result = [];\r\n\r\n  if (node.hasChildNodes()) {\r\n    for (let i = 0; i < node.childNodes.length; i += 1) {\r\n      const child = node.childNodes[i];\r\n\r\n      if (child.nodeName === \"#comment\" || child.nodeName === \"#text\") {\r\n        continue;\r\n      }\r\n\r\n      const selectedDescriptionId = getRequiredAttr(\r\n        child,\r\n        \"selected-description-id\"\r\n      );\r\n      const selectedButtonId = getRequiredAttr(child, \"selected-button-id\");\r\n\r\n      if (child.nodeName === \"button_description\") {\r\n        result.push({\r\n          id: uuid.v4(),\r\n          selectedDescriptionId: selectedDescriptionId,\r\n          selectedButtonId: selectedButtonId,\r\n        });\r\n      } else {\r\n        throw new Error(\r\n          \"button_descriptions element contains illegal child: \" +\r\n            child.nodeName\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  return result;\r\n}\r\n"]},"metadata":{},"sourceType":"module"}