{"ast":null,"code":"import _objectSpread from\"C:\\\\project\\\\SCF-NI_PM_App\\\\SCF.InstallationQuality\\\\react-client\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/objectSpread2\";import*as action from\"actions\";import*as api from\"api\";import{Base64}from\"js-base64\";import{serialize,deserialize}from\"js/sfdl\";import{checkTemplateForm,getDraft,getRawTemplate}from\"js/util\";import{initFormState}from\"js/templateFormUtil\";import store from\"js/store\";import moment from\"moment\";export var setTemplateFormState=function setTemplateFormState(state){return{type:\"SET_TEMPLATE_FORM_STATE\",payload:state};};export var removeTemplateFormState=function removeTemplateFormState(data){return{type:\"REMOVE_TEMPLATE_FORM_STATE\",payload:data};};export var handleOnChange=function handleOnChange(data){return{type:\"HANDLE_COMPONENT_VALUE_ONCHANGE\",payload:data};};export var storeCurrentParams=function storeCurrentParams(data){return{type:\"STORE_CURRENT_PARAMS\",payload:data};};export var initTemplateForm=function initTemplateForm(documentNo,documentPart,activityNo,productFamily,productLine,language,data,routeParams){return function(dispatch){var templateForm={};templateForm[documentNo+\"-\"+documentPart+\"-\"+activityNo+\"-\"+productFamily+\"-\"+productLine+\"-\"+language]=initFormState(deserialize(Base64.decode(data)),routeParams);dispatch(action.setTemplateFormState(templateForm));return Promise.resolve(Base64.encode(serialize(templateForm[documentNo+\"-\"+documentPart+\"-\"+activityNo+\"-\"+productFamily+\"-\"+productLine+\"-\"+language])));};};/**\r\n * code: 1: 正常数据 xml的 base64\r\n *       2: 提示模板有变动，draft 失效\r\n *       3：draft 不存在\r\n */export var fetchTemplateForm=function fetchTemplateForm(param,draftParam,expendParam){return function(dispatch){dispatch(action.showLoading());var documentNo=param.documentNo,documentPart=param.documentPart;return api.fetchTemplateFormData(param).then(function(response){var date=moment(response[\"headers\"][\"date\"]).format(\"YYYY-MM-DD\");dispatch(action.setAuth(_objectSpread(_objectSpread({},store.getState().auth),{},{CurrentDate:date})));// 1. check raw base64 string\nreturn checkTemplateForm(documentNo,documentPart,response.data.value).then(function(data){if(data.code===3||data.code===1){// 接口template和本地template相同 \n// 2. get draft\nreturn getDraft(param,draftParam,expendParam).then(function(data){if(data.code===2){// 本地和远端草稿不存在\nreturn getRawTemplate(documentNo,documentPart).then(function(data){return Promise.resolve({code:1,value:data});});}else{return Promise.resolve(data);}});}else{return Promise.resolve(data);}});}).catch(function(error){if(error.code===401){window.localStorage.removeItem(\"auth\");dispatch(action.setAuth(null));}dispatch(action.setError(error.message));}).finally(function(){dispatch(action.hideLoading());});};};","map":{"version":3,"sources":["C:/project/SCF-NI_PM_App/SCF.InstallationQuality/react-client/src/actions/templateForm.js"],"names":["action","api","Base64","serialize","deserialize","checkTemplateForm","getDraft","getRawTemplate","initFormState","store","moment","setTemplateFormState","state","type","payload","removeTemplateFormState","data","handleOnChange","storeCurrentParams","initTemplateForm","documentNo","documentPart","activityNo","productFamily","productLine","language","routeParams","dispatch","templateForm","decode","Promise","resolve","encode","fetchTemplateForm","param","draftParam","expendParam","showLoading","fetchTemplateFormData","then","response","date","format","setAuth","getState","auth","CurrentDate","value","code","catch","error","window","localStorage","removeItem","setError","message","finally","hideLoading"],"mappings":"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","sourcesContent":["import * as action from \"actions\";\r\nimport * as api from \"api\";\r\nimport { Base64 } from \"js-base64\";\r\nimport { serialize, deserialize } from \"js/sfdl\";\r\nimport { checkTemplateForm, getDraft, getRawTemplate } from \"js/util\";\r\nimport { initFormState } from \"js/templateFormUtil\";\r\nimport store from \"js/store\";\r\nimport moment from \"moment\";\r\n\r\nexport const setTemplateFormState = (state) => ({\r\n  type: \"SET_TEMPLATE_FORM_STATE\",\r\n  payload: state,\r\n});\r\n\r\nexport const removeTemplateFormState = (data) => ({\r\n  type: \"REMOVE_TEMPLATE_FORM_STATE\",\r\n  payload: data,\r\n});\r\n\r\nexport const handleOnChange = (data) => ({\r\n  type: \"HANDLE_COMPONENT_VALUE_ONCHANGE\",\r\n  payload: data,\r\n});\r\n\r\nexport const storeCurrentParams = (data) => ({\r\n  type: \"STORE_CURRENT_PARAMS\",\r\n  payload: data,\r\n});\r\n\r\nexport const initTemplateForm =\r\n  (\r\n    documentNo,\r\n    documentPart,\r\n    activityNo,\r\n    productFamily,\r\n    productLine,\r\n    language,\r\n    data,\r\n    routeParams\r\n  ) =>\r\n  (dispatch) => {\r\n    const templateForm = {};\r\n    templateForm[\r\n      documentNo +\r\n        \"-\" +\r\n        documentPart +\r\n        \"-\" +\r\n        activityNo +\r\n        \"-\" +\r\n        productFamily +\r\n        \"-\" +\r\n        productLine +\r\n        \"-\" +\r\n        language\r\n    ] = initFormState(deserialize(Base64.decode(data)), routeParams);\r\n    dispatch(action.setTemplateFormState(templateForm));\r\n    return Promise.resolve(\r\n      Base64.encode(\r\n        serialize(\r\n          templateForm[\r\n            documentNo +\r\n              \"-\" +\r\n              documentPart +\r\n              \"-\" +\r\n              activityNo +\r\n              \"-\" +\r\n              productFamily +\r\n              \"-\" +\r\n              productLine +\r\n              \"-\" +\r\n              language\r\n          ]\r\n        )\r\n      )\r\n    );\r\n  };\r\n\r\n/**\r\n * code: 1: 正常数据 xml的 base64\r\n *       2: 提示模板有变动，draft 失效\r\n *       3：draft 不存在\r\n */\r\nexport const fetchTemplateForm =\r\n  (param, draftParam, expendParam) => (dispatch) => {\r\n    dispatch(action.showLoading());\r\n    const { documentNo, documentPart } = param;\r\n\r\n    return api\r\n      .fetchTemplateFormData(param)\r\n      .then((response) => {\r\n        const date = moment(response[\"headers\"][\"date\"]).format(\"YYYY-MM-DD\")\r\n        dispatch(action.setAuth({ ...store.getState().auth, CurrentDate: date }));\r\n        // 1. check raw base64 string\r\n        return checkTemplateForm(\r\n          documentNo,\r\n          documentPart,\r\n          response.data.value\r\n        ).then((data) => {\r\n          if (data.code === 3 || data.code === 1) {\r\n            // 接口template和本地template相同 \r\n            // 2. get draft\r\n            return getDraft(param, draftParam, expendParam).then((data) => {\r\n              if (data.code === 2) {\r\n                // 本地和远端草稿不存在\r\n                return getRawTemplate(documentNo, documentPart).then((data) => {\r\n                  return Promise.resolve({ code: 1, value: data });\r\n                });\r\n              } else {\r\n                return Promise.resolve(data);\r\n              }\r\n            });\r\n          } else {\r\n            return Promise.resolve(data);\r\n          }\r\n        });\r\n      })\r\n      .catch((error) => {\r\n        if (error.code === 401) {\r\n          window.localStorage.removeItem(\"auth\");\r\n          dispatch(action.setAuth(null));\r\n        }\r\n        dispatch(action.setError(error.message));\r\n      })\r\n      .finally(() => {\r\n        dispatch(action.hideLoading());\r\n      });\r\n  };\r\n"]},"metadata":{},"sourceType":"module"}