{"ast":null,"code":"import * as action from \"actions\";\nimport * as api from \"api\";\nimport { Base64 } from \"js-base64\";\nimport { serialize, deserialize } from \"js/sfdl\";\nimport { checkTemplateForm, getDraft, getRawTemplate } from \"js/util\";\nimport { initFormState } from \"js/templateFormUtil\";\nimport store from \"js/store\";\nimport moment from \"moment\";\nimport { removeNotVisibleFields } from \"js/util\";\nimport { getOfflineForm } from \"js/util\";\nexport const setTemplateFormState = state => ({\n  type: \"SET_TEMPLATE_FORM_STATE\",\n  payload: state\n});\nexport const removeTemplateFormState = data => ({\n  type: \"REMOVE_TEMPLATE_FORM_STATE\",\n  payload: data\n});\nexport const handleOnChange = data => ({\n  type: \"HANDLE_COMPONENT_VALUE_ONCHANGE\",\n  payload: data\n});\nexport const storeCurrentParams = data => ({\n  type: \"STORE_CURRENT_PARAMS\",\n  payload: data\n});\nexport const initTemplateForm = (documentNo, documentPart, activityNo, productFamily, productLine, language, data, routeParams) => dispatch => {\n  const templateForm = {};\n  templateForm[documentNo + \"-\" + documentPart + \"-\" + activityNo + \"-\" + productFamily + \"-\" + productLine + \"-\" + language] = initFormState(deserialize(Base64.decode(data)), routeParams);\n  dispatch(action.setTemplateFormState(templateForm));\n  return Promise.resolve(Base64.encode(serialize(templateForm[documentNo + \"-\" + documentPart + \"-\" + activityNo + \"-\" + productFamily + \"-\" + productLine + \"-\" + language])));\n};\n/**\r\n * code: 1: 正常数据 xml的 base64\r\n *       2: 提示模板有变动，draft 失效\r\n *       3：draft 不存在\r\n */\n\nexport const fetchTemplateForm = (param, draftParam, expendParam) => dispatch => {\n  dispatch(action.showLoading());\n  const {\n    documentNo,\n    documentPart\n  } = param;\n  return api.fetchTemplateFormData(param).then(response => {\n    const date = moment(response[\"headers\"][\"date\"]).format(\"YYYY-MM-DD\");\n    dispatch(action.setAuth({ ...store.getState().auth,\n      CurrentDate: date\n    })); // 1. check raw base64 string\n\n    return checkTemplateForm(documentNo, documentPart, response.data.value).then(data => {\n      if (data.code === 3 || data.code === 1) {\n        // 接口template和本地template相同 \n        // 2. get draft\n        return getDraft(param, draftParam, expendParam).then(data => {\n          if (data.code === 2) {\n            // 本地和远端草稿不存在\n            return getRawTemplate(documentNo, documentPart).then(data => {\n              return Promise.resolve({\n                code: 1,\n                value: data\n              });\n            });\n          } else {\n            const key = `${draftParam.ProjectNo}-${draftParam.orderNo}-${draftParam.activityNo}`;\n            getOfflineForm(data.value, key).then(res => {});\n            const offlineData = {\n              code: data.code,\n              value: result\n            };\n            return offlineData;\n          }\n        });\n      } else {\n        return Promise.resolve(data);\n      }\n    });\n  }).catch(error => {\n    if (error.code === 401) {\n      window.localStorage.removeItem(\"auth\");\n      dispatch(action.setAuth(null));\n    }\n\n    dispatch(action.setError(error.message));\n  }).finally(() => {\n    dispatch(action.hideLoading());\n  });\n};","map":{"version":3,"sources":["C:/project/SCF-NI_PM_App/SCF.InstallationQuality/react-client/src/actions/templateForm.js"],"names":["action","api","Base64","serialize","deserialize","checkTemplateForm","getDraft","getRawTemplate","initFormState","store","moment","removeNotVisibleFields","getOfflineForm","setTemplateFormState","state","type","payload","removeTemplateFormState","data","handleOnChange","storeCurrentParams","initTemplateForm","documentNo","documentPart","activityNo","productFamily","productLine","language","routeParams","dispatch","templateForm","decode","Promise","resolve","encode","fetchTemplateForm","param","draftParam","expendParam","showLoading","fetchTemplateFormData","then","response","date","format","setAuth","getState","auth","CurrentDate","value","code","key","ProjectNo","orderNo","res","offlineData","result","catch","error","window","localStorage","removeItem","setError","message","finally","hideLoading"],"mappings":"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","sourcesContent":["import * as action from \"actions\";\r\nimport * as api from \"api\";\r\nimport { Base64 } from \"js-base64\";\r\nimport { serialize, deserialize } from \"js/sfdl\";\r\nimport { checkTemplateForm, getDraft, getRawTemplate } from \"js/util\";\r\nimport { initFormState } from \"js/templateFormUtil\";\r\nimport store from \"js/store\";\r\nimport moment from \"moment\";\r\nimport { removeNotVisibleFields } from \"js/util\";\r\nimport { getOfflineForm } from \"js/util\";\r\n\r\nexport const setTemplateFormState = (state) => ({\r\n  type: \"SET_TEMPLATE_FORM_STATE\",\r\n  payload: state,\r\n});\r\n\r\nexport const removeTemplateFormState = (data) => ({\r\n  type: \"REMOVE_TEMPLATE_FORM_STATE\",\r\n  payload: data,\r\n});\r\n\r\nexport const handleOnChange = (data) => ({\r\n  type: \"HANDLE_COMPONENT_VALUE_ONCHANGE\",\r\n  payload: data,\r\n});\r\n\r\nexport const storeCurrentParams = (data) => ({\r\n  type: \"STORE_CURRENT_PARAMS\",\r\n  payload: data,\r\n});\r\n\r\nexport const initTemplateForm =\r\n  (\r\n    documentNo,\r\n    documentPart,\r\n    activityNo,\r\n    productFamily,\r\n    productLine,\r\n    language,\r\n    data,\r\n    routeParams\r\n  ) =>\r\n  (dispatch) => {\r\n    const templateForm = {};\r\n    templateForm[\r\n      documentNo +\r\n        \"-\" +\r\n        documentPart +\r\n        \"-\" +\r\n        activityNo +\r\n        \"-\" +\r\n        productFamily +\r\n        \"-\" +\r\n        productLine +\r\n        \"-\" +\r\n        language\r\n    ] = initFormState(deserialize(Base64.decode(data)), routeParams);\r\n    dispatch(action.setTemplateFormState(templateForm));\r\n    return Promise.resolve(\r\n      Base64.encode(\r\n        serialize(\r\n          templateForm[\r\n            documentNo +\r\n              \"-\" +\r\n              documentPart +\r\n              \"-\" +\r\n              activityNo +\r\n              \"-\" +\r\n              productFamily +\r\n              \"-\" +\r\n              productLine +\r\n              \"-\" +\r\n              language\r\n          ]\r\n        )\r\n      )\r\n    );\r\n  };\r\n\r\n/**\r\n * code: 1: 正常数据 xml的 base64\r\n *       2: 提示模板有变动，draft 失效\r\n *       3：draft 不存在\r\n */\r\nexport const fetchTemplateForm =\r\n  (param, draftParam, expendParam) => (dispatch) => {\r\n    dispatch(action.showLoading());\r\n    const { documentNo, documentPart } = param;\r\n\r\n    return api\r\n      .fetchTemplateFormData(param)\r\n      .then((response) => {\r\n        const date = moment(response[\"headers\"][\"date\"]).format(\"YYYY-MM-DD\")\r\n        dispatch(action.setAuth({ ...store.getState().auth, CurrentDate: date }));\r\n        // 1. check raw base64 string\r\n        return checkTemplateForm(\r\n          documentNo,\r\n          documentPart,\r\n          response.data.value\r\n        ).then((data) => {\r\n          if (data.code === 3 || data.code === 1) {\r\n            // 接口template和本地template相同 \r\n            // 2. get draft\r\n            return getDraft(param, draftParam, expendParam).then((data) => {\r\n              if (data.code === 2) {\r\n                // 本地和远端草稿不存在\r\n                return getRawTemplate(documentNo, documentPart).then((data) => {\r\n                  return Promise.resolve({ code: 1, value: data });\r\n                });\r\n              } else {\r\n                const key = `${draftParam.ProjectNo}-${draftParam.orderNo}-${draftParam.activityNo}`\r\n                 getOfflineForm(data.value, key).then((res)=>{});\r\n                const offlineData = { code: data.code, value: result };\r\n                return offlineData;\r\n              }\r\n            });\r\n          } else {\r\n            return Promise.resolve(data);\r\n          }\r\n        });\r\n      })\r\n      .catch((error) => {\r\n        if (error.code === 401) {\r\n          window.localStorage.removeItem(\"auth\");\r\n          dispatch(action.setAuth(null));\r\n        }\r\n        dispatch(action.setError(error.message));\r\n      })\r\n      .finally(() => {\r\n        dispatch(action.hideLoading());\r\n      });\r\n  };\r\n"]},"metadata":{},"sourceType":"module"}