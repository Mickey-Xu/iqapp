{"ast":null,"code":"var _jsxFileName = \"C:\\\\project\\\\SCF-NI_PM_App\\\\SCF.InstallationQuality\\\\react-client\\\\src\\\\pages\\\\TemplatePage\\\\index.js\";\nimport { Box, Button } from \"@material-ui/core\";\nimport { withStyles } from \"@material-ui/core/styles\";\nimport * as action from \"actions\";\nimport ConfirmModal from \"components/ConfirmModal\";\nimport { TitlePage } from \"components/TemplateForm/TitlePage\";\nimport { LocalizeContext } from \"i18n\";\nimport { Base64 } from \"js-base64\";\nimport { deserialize, serialize } from \"js/sfdl\";\nimport { componentGenerator, initProps, isVisible, tmplLangMapper } from \"js/templateFormUtil\";\nimport { deleteDraftFromLocal, isFormUpdated, verify, removeNotVisibleFields } from \"js/util\";\nimport PrimaryLayout from \"layouts/PrimaryLayout\";\nimport React, { useEffect, useState } from \"react\";\nimport { connect } from \"react-redux\";\nimport { useHistory, useParams } from \"react-router-dom\";\nimport * as repo from \"js/fetch\";\nimport FilterIcon from \"../../assets/img/filter.png\";\nimport TemplateFilter from \"../../components/TemplateFilter\";\nimport { db } from \"js/db\";\nconst TemplatePage = withStyles(({\n  spacing\n}) => {\n  return {\n    root: {\n      width: \"100%\",\n      fontWeight: 500,\n      position: \"fixed\",\n      top: \"54px\",\n      display: \"flex\",\n      justifyContent: \"space-between\",\n      backgroundColor: \" #efe9e9\",\n      borderBottom: \"1px solid #eae9e9\",\n      zIndex: \"1\"\n    },\n    btn: {\n      color: \"#123db5\",\n      textTransform: \"capitalize\",\n      marginRight: spacing(2)\n    },\n    container: {\n      margin: spacing(7, 2, 0, 2)\n    }\n  };\n})(({\n  description,\n  savePDF,\n  classes,\n  formState,\n  fieldsState,\n  getTemplateForm,\n  templateFormData,\n  initTemplateForm,\n  storeCurrentParams,\n  activityNo,\n  orderNo,\n  projectNumber,\n  fo: foe,\n  region,\n  prctr: branch,\n  saveAndReturn,\n  removeTemplateState,\n  productFamily,\n  productLine,\n  language\n}) => {\n  const i18n = React.useContext(LocalizeContext);\n  let {\n    documentNo,\n    documentPart\n  } = useParams();\n  const [initData, setInitData] = useState(null);\n  const [dialog, setDialog] = React.useState(false);\n  const [checked, setChecked] = React.useState([1]);\n  const [templateForm, setTemplateForm] = useState({\n    fields: []\n  });\n\n  const useInitForm = () => {\n    useEffect(() => {\n      getTemplateForm({\n        documentNo,\n        documentPart\n      }, {\n        ProjectNo: projectNumber,\n        orderNo,\n        activityNo,\n        description,\n        branch,\n        foe,\n        region\n      }, {\n        activityNo,\n        productFamily,\n        productLine,\n        language\n      }).then(res => {\n        initTemplateForm(documentNo, documentPart, activityNo, productFamily, productLine, language, res.value, {\n          orderNo\n        }).then(data => {\n          setInitData(data);\n        });\n\n        if (res.code === 1) {\n          alert(\"模板有更新，之前草稿已被清理\");\n          deleteDraftFromLocal({\n            documentNo,\n            documentPart\n          });\n          db.cache.put({\n            id: \"offlineForm\",\n            data: []\n          });\n        }\n      });\n      storeCurrentParams({\n        documentNo,\n        documentPart,\n        activityNo,\n        productFamily,\n        productLine,\n        language\n      });\n    }, []);\n  };\n\n  useInitForm();\n  const history = useHistory();\n  const [open, setOpen] = useState(false);\n\n  const closeMenu = () => {\n    removeTemplateState(documentNo, documentPart, activityNo, productFamily, productLine, language);\n    history.goBack();\n    setOpen(false);\n  };\n\n  const submit = e => {\n    const result = verify(templateFormData.fields);\n\n    if (result) {\n      let data = {\n        projectNo: projectNumber,\n        orderNo: orderNo,\n        activityNo: activityNo,\n        description: description,\n        branch,\n        foe,\n        region,\n        override: true,\n        form: Base64.encode(serialize(removeNotVisibleFields(templateFormData)))\n      };\n      let draftData = {\n        projectNo: projectNumber,\n        orderNo: orderNo,\n        activityNo: activityNo,\n        description: description,\n        branch: branch,\n        foe: foe,\n        region: region,\n        form: Base64.encode(serialize(templateFormData))\n      };\n      savePDF(data, draftData, {\n        documentNo,\n        documentPart,\n        activityNo,\n        productFamily,\n        productLine,\n        language\n      });\n    }\n  };\n\n  const goBack = () => {\n    if (isFormUpdated(templateFormData, deserialize(Base64.decode(initData)))) {\n      setOpen(true);\n    } else {\n      removeTemplateState(documentNo, documentPart, activityNo, productFamily, productLine, language);\n      history.goBack();\n    }\n  };\n\n  const saveDraft = type => {\n    setOpen(false);\n    let data = {\n      projectNo: projectNumber,\n      orderNo: orderNo,\n      activityNo: activityNo,\n      description: description,\n      branch: branch,\n      foe: foe,\n      region: region,\n      form: Base64.encode(serialize(templateFormData))\n    };\n    const currentParams = {\n      documentNo,\n      documentPart\n    };\n\n    if (type === \"save\") {\n      saveAndReturn(data, currentParams, {\n        productFamily,\n        productLine,\n        language\n      }).then(() => {\n        setInitData(data.form);\n        alert(\"草稿保存成功\");\n      });\n    } else {\n      saveAndReturn(data, currentParams, {\n        productFamily,\n        productLine,\n        language\n      }).then(() => {\n        history.goBack();\n        removeTemplateState(documentNo, documentPart, activityNo, productFamily, productLine, language);\n      });\n    }\n  };\n\n  const handleToggle = value => () => {\n    const currentIndex = checked.indexOf(value);\n    const newChecked = [...checked];\n\n    if (currentIndex === -1) {\n      newChecked.push(value);\n    } else {\n      newChecked.splice(currentIndex, 1);\n    }\n\n    setChecked(newChecked);\n  };\n\n  const confirmFilter = () => {\n    if (checked.length > 1) {\n      const checkedId = [];\n      checked.forEach(item => (item === null || item === void 0 ? void 0 : item.id) && checkedId.push(item.id));\n      const fields = [];\n      checkedId.forEach(item => {\n        templateFormData[\"fields\"].forEach(field => {\n          field.settings.tagRules.forEach(tagRule => {\n            item === tagRule.tagId && fields.push(field);\n          });\n        });\n      });\n      console.log(fields);\n      setTemplateForm({ ...templateFormData,\n        fields: fields\n      });\n    } else {\n      setTemplateForm(templateFormData);\n    }\n\n    setDialog(false);\n  };\n\n  const offlineSaving = () => {\n    const key = `${projectNumber}-${orderNo}-${activityNo}`;\n    const data = {\n      [key]: Base64.encode(serialize(templateFormData))\n    };\n    db.cache.get(\"offlineForm\").then(res => {\n      const formData = (res === null || res === void 0 ? void 0 : res.data) ? res.data : [];\n      let index = formData.findIndex(item => Object.keys(item)[0] === Object.keys(data)[0]);\n      index >= 0 ? formData[index] = data : formData.push(data);\n      db.cache.put({\n        id: \"offlineForm\",\n        data: formData\n      });\n      alert('离线保存成功');\n    });\n  };\n\n  return /*#__PURE__*/React.createElement(PrimaryLayout, {\n    title: i18n.ISNTAPP_TEMPLATE,\n    isDirectReturn: false,\n    isFetchAll: false,\n    goBack: goBack,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 303,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(Box, {\n    className: classes.root,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 309,\n      columnNumber: 9\n    }\n  }, (templateFormData === null || templateFormData === void 0 ? void 0 : templateFormData.form[\"settings\"][\"tagUniverse\"].length) > 0 ? /*#__PURE__*/React.createElement(Button, {\n    onClick: () => setDialog(true),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 310,\n      columnNumber: 75\n    }\n  }, /*#__PURE__*/React.createElement(\"img\", {\n    src: FilterIcon,\n    alt: \"\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 313,\n      columnNumber: 13\n    }\n  })) : /*#__PURE__*/React.createElement(Box, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 314,\n      columnNumber: 21\n    }\n  }), /*#__PURE__*/React.createElement(Box, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 315,\n      columnNumber: 11\n    }\n  }, /*#__PURE__*/React.createElement(Button, {\n    className: classes.btn,\n    onClick: () => offlineSaving(),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 316,\n      columnNumber: 13\n    }\n  }, \"\\u79BB\\u7EBF\\u4FDD\\u5B58\"), /*#__PURE__*/React.createElement(Button, {\n    className: classes.btn,\n    onClick: () => saveDraft(\"save\"),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 319,\n      columnNumber: 13\n    }\n  }, i18n.ISNTAPP_SAVE_AS_PDF), /*#__PURE__*/React.createElement(Button, {\n    className: classes.btn,\n    onClick: () => submit(),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 322,\n      columnNumber: 13\n    }\n  }, i18n.ISNTAPP_TEMPLATE_UPLOAD))), /*#__PURE__*/React.createElement(Box, {\n    className: classes.container,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 327,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(TitlePage, Object.assign({}, formState, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 328,\n      columnNumber: 11\n    }\n  })), (checked.length > 1 ? templateForm[\"fields\"] : fieldsState).map(field => {\n    return isVisible(field) ? componentGenerator(field, initProps(field, language)) : null;\n  })), /*#__PURE__*/React.createElement(ConfirmModal, {\n    open: open,\n    onClose: closeMenu,\n    handleClick: () => saveDraft(),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 335,\n      columnNumber: 9\n    }\n  }, i18n.INSTALLATION_DO_YOU_WANGT_TO_SAVE_THE_DRAFT), /*#__PURE__*/React.createElement(TemplateFilter, {\n    templateForm: templateFormData,\n    open: dialog,\n    setOpen: setDialog,\n    handleToggle: handleToggle,\n    checked: checked,\n    confirmFilter: confirmFilter,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 342,\n      columnNumber: 9\n    }\n  }));\n});\n\nconst mapStateToProps = ({\n  templateForm,\n  templates,\n  orders\n}, ownProps) => {\n  var _templates$activityNo;\n\n  let {\n    activityNo,\n    documentPart,\n    orderNo,\n    projectNumber,\n    documentNo,\n    productFamily,\n    productLine,\n    language\n  } = ownProps.match.params;\n  const key = documentNo + \"-\" + documentPart + \"-\" + activityNo + \"-\" + productFamily + \"-\" + productLine + \"-\" + language;\n  let formState = {};\n  let fieldsState = [];\n\n  if (templateForm[key]) {\n    var _templateForm$key$for, _templateForm$key$for2, _templateForm$key$for3, _templateForm$key$for4, _templateForm$key$for5, _templateForm$key$for6, _templateForm$key$for7, _templateForm$key$for8;\n\n    formState = {\n      title: ((_templateForm$key$for = templateForm[key].form) === null || _templateForm$key$for === void 0 ? void 0 : _templateForm$key$for.settings.titleI18n[tmplLangMapper[language]]) ? (_templateForm$key$for2 = templateForm[key].form) === null || _templateForm$key$for2 === void 0 ? void 0 : _templateForm$key$for2.settings.titleI18n[tmplLangMapper[language]] : (_templateForm$key$for3 = templateForm[key].form) === null || _templateForm$key$for3 === void 0 ? void 0 : _templateForm$key$for3.settings.titleI18n.English,\n      description: ((_templateForm$key$for4 = templateForm[key].form) === null || _templateForm$key$for4 === void 0 ? void 0 : _templateForm$key$for4.settings.descriptionI18n[tmplLangMapper[language]]) ? (_templateForm$key$for5 = templateForm[key].form) === null || _templateForm$key$for5 === void 0 ? void 0 : _templateForm$key$for5.settings.descriptionI18n[tmplLangMapper[language]] : (_templateForm$key$for6 = templateForm[key].form) === null || _templateForm$key$for6 === void 0 ? void 0 : _templateForm$key$for6.settings.descriptionI18n.English,\n      logos: (_templateForm$key$for7 = templateForm[key].form) === null || _templateForm$key$for7 === void 0 ? void 0 : _templateForm$key$for7.settings.logos,\n      identifier: (_templateForm$key$for8 = templateForm[key].form) === null || _templateForm$key$for8 === void 0 ? void 0 : _templateForm$key$for8.settings.identifier\n    };\n    fieldsState = templateForm[key].fields;\n  }\n\n  let templateFormData = templateForm[key];\n  let description = (_templates$activityNo = templates[activityNo]) === null || _templates$activityNo === void 0 ? void 0 : _templates$activityNo.find(item => item.documentPart === documentPart && item.documentNo === documentNo && item.productFamily === (productFamily === \"null\" ? null : productFamily) && item.productLine === (productLine === \"null\" ? null : productLine) && item.language === language).documentDescription;\n  let order = orders === null || orders === void 0 ? void 0 : orders[orderNo];\n  return {\n    formState,\n    fieldsState,\n    templateFormData,\n    activityNo,\n    orderNo,\n    projectNumber,\n    description,\n    fo: order === null || order === void 0 ? void 0 : order.fo,\n    region: order === null || order === void 0 ? void 0 : order.region,\n    prctr: order === null || order === void 0 ? void 0 : order.prctr,\n    productFamily,\n    productLine,\n    language\n  };\n};\n\nconst mapDispatchToProps = dispatch => {\n  return {\n    storeCurrentParams: param => {\n      dispatch(action.storeCurrentParams(param));\n    },\n    getTemplateForm: (param, draftParam, expendParam) => {\n      dispatch(action.fetchAll(repo.type.CACHE));\n      return dispatch(action.fetchTemplateForm(param, draftParam, expendParam));\n    },\n    initTemplateForm: (documentNo, documentPart, activityNo, productFamily, productLine, language, data, routeParams) => {\n      return dispatch(action.initTemplateForm(documentNo, documentPart, activityNo, productFamily, productLine, language, data, routeParams));\n    },\n    savePDF: (data, draftData, param) => {\n      dispatch(action.uploadDocumentForm(data, draftData, param));\n    },\n    saveAndReturn: (data, currentParams, extendParam) => {\n      return dispatch(action.saveDraft(data, currentParams, extendParam));\n    },\n    removeTemplateState: (documentNo, documentPart, activityNo, productFamily, productLine, language) => {\n      dispatch(action.removeTemplateFormState({\n        documentNo,\n        documentPart,\n        activityNo,\n        productFamily,\n        productLine,\n        language\n      }));\n    }\n  };\n};\n\nexport default connect(mapStateToProps, mapDispatchToProps)(TemplatePage);\n/*\r\n离线表单\r\n  1.如果本地存在 则先用本地离线表单\r\n  2.没有则用草稿\r\n  3.草稿没有 用接口模板\r\n\r\n  反之 如果保存了离线表单  远端草稿发生更新 本地离线表单则不能及时更新  （因为优先本地离线表单）\r\n\r\n\r\n\r\n  什么情况下草稿会更新？？？\r\n*/","map":{"version":3,"sources":["C:/project/SCF-NI_PM_App/SCF.InstallationQuality/react-client/src/pages/TemplatePage/index.js"],"names":["Box","Button","withStyles","action","ConfirmModal","TitlePage","LocalizeContext","Base64","deserialize","serialize","componentGenerator","initProps","isVisible","tmplLangMapper","deleteDraftFromLocal","isFormUpdated","verify","removeNotVisibleFields","PrimaryLayout","React","useEffect","useState","connect","useHistory","useParams","repo","FilterIcon","TemplateFilter","db","TemplatePage","spacing","root","width","fontWeight","position","top","display","justifyContent","backgroundColor","borderBottom","zIndex","btn","color","textTransform","marginRight","container","margin","description","savePDF","classes","formState","fieldsState","getTemplateForm","templateFormData","initTemplateForm","storeCurrentParams","activityNo","orderNo","projectNumber","fo","foe","region","prctr","branch","saveAndReturn","removeTemplateState","productFamily","productLine","language","i18n","useContext","documentNo","documentPart","initData","setInitData","dialog","setDialog","checked","setChecked","templateForm","setTemplateForm","fields","useInitForm","ProjectNo","then","res","value","data","code","alert","cache","put","id","history","open","setOpen","closeMenu","goBack","submit","e","result","projectNo","override","form","encode","draftData","decode","saveDraft","type","currentParams","handleToggle","currentIndex","indexOf","newChecked","push","splice","confirmFilter","length","checkedId","forEach","item","field","settings","tagRules","tagRule","tagId","console","log","offlineSaving","key","get","formData","index","findIndex","Object","keys","ISNTAPP_TEMPLATE","ISNTAPP_SAVE_AS_PDF","ISNTAPP_TEMPLATE_UPLOAD","map","INSTALLATION_DO_YOU_WANGT_TO_SAVE_THE_DRAFT","mapStateToProps","templates","orders","ownProps","match","params","title","titleI18n","English","descriptionI18n","logos","identifier","find","documentDescription","order","mapDispatchToProps","dispatch","param","draftParam","expendParam","fetchAll","CACHE","fetchTemplateForm","routeParams","uploadDocumentForm","extendParam","removeTemplateFormState"],"mappings":"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","sourcesContent":["import { Box, Button } from \"@material-ui/core\";\r\nimport { withStyles } from \"@material-ui/core/styles\";\r\nimport * as action from \"actions\";\r\nimport ConfirmModal from \"components/ConfirmModal\";\r\nimport { TitlePage } from \"components/TemplateForm/TitlePage\";\r\nimport { LocalizeContext } from \"i18n\";\r\nimport { Base64 } from \"js-base64\";\r\nimport { deserialize, serialize } from \"js/sfdl\";\r\nimport {\r\n  componentGenerator,\r\n  initProps,\r\n  isVisible,\r\n  tmplLangMapper,\r\n} from \"js/templateFormUtil\";\r\nimport {\r\n  deleteDraftFromLocal,\r\n  isFormUpdated,\r\n  verify,\r\n  removeNotVisibleFields,\r\n} from \"js/util\";\r\nimport PrimaryLayout from \"layouts/PrimaryLayout\";\r\nimport React, { useEffect, useState } from \"react\";\r\nimport { connect } from \"react-redux\";\r\nimport { useHistory, useParams } from \"react-router-dom\";\r\nimport * as repo from \"js/fetch\";\r\nimport FilterIcon from \"../../assets/img/filter.png\";\r\nimport TemplateFilter from \"../../components/TemplateFilter\"\r\nimport { db } from \"js/db\";\r\n\r\nconst TemplatePage = withStyles(({ spacing }) => {\r\n  return {\r\n    root: {\r\n      width: \"100%\",\r\n      fontWeight: 500,\r\n      position: \"fixed\",\r\n      top: \"54px\",\r\n      display: \"flex\",\r\n      justifyContent: \"space-between\",\r\n      backgroundColor: \" #efe9e9\",\r\n      borderBottom: \"1px solid #eae9e9\",\r\n      zIndex: \"1\",\r\n    },\r\n    btn: {\r\n      color: \"#123db5\",\r\n      textTransform: \"capitalize\",\r\n      marginRight: spacing(2),\r\n    },\r\n    container: {\r\n      margin: spacing(7, 2, 0, 2),\r\n    },\r\n  };\r\n})(\r\n  ({\r\n    description,\r\n    savePDF,\r\n    classes,\r\n    formState,\r\n    fieldsState,\r\n    getTemplateForm,\r\n    templateFormData,\r\n    initTemplateForm,\r\n    storeCurrentParams,\r\n    activityNo,\r\n    orderNo,\r\n    projectNumber,\r\n    fo: foe,\r\n    region,\r\n    prctr: branch,\r\n    saveAndReturn,\r\n    removeTemplateState,\r\n    productFamily,\r\n    productLine,\r\n    language,\r\n  }) => {\r\n    const i18n = React.useContext(LocalizeContext);\r\n    let { documentNo, documentPart } = useParams();\r\n    const [initData, setInitData] = useState(null);\r\n    const [dialog, setDialog] = React.useState(false);\r\n    const [checked, setChecked] = React.useState([1]);\r\n    const [templateForm, setTemplateForm] = useState({ fields:[]});\r\n\r\n    const useInitForm = () => {\r\n      useEffect(() => {\r\n        getTemplateForm(\r\n          {\r\n            documentNo,\r\n            documentPart,\r\n          },\r\n          {\r\n            ProjectNo: projectNumber,\r\n            orderNo,\r\n            activityNo,\r\n            description,\r\n            branch,\r\n            foe,\r\n            region,\r\n          },\r\n          {\r\n            activityNo,\r\n            productFamily,\r\n            productLine,\r\n            language,\r\n          }\r\n        ).then((res) => {\r\n          initTemplateForm(\r\n            documentNo,\r\n            documentPart,\r\n            activityNo,\r\n            productFamily,\r\n            productLine,\r\n            language,\r\n            res.value,\r\n            { orderNo }\r\n          ).then((data) => {\r\n            setInitData(data);\r\n          });\r\n          if (res.code === 1) {\r\n            alert(\"模板有更新，之前草稿已被清理\");\r\n            deleteDraftFromLocal({\r\n              documentNo,\r\n              documentPart,\r\n            });\r\n            db.cache.put({ id: \"offlineForm\", data: [] })\r\n          }\r\n        });\r\n\r\n        storeCurrentParams({\r\n          documentNo,\r\n          documentPart,\r\n          activityNo,\r\n          productFamily,\r\n          productLine,\r\n          language,\r\n        });\r\n      }, []);\r\n    };\r\n\r\n    useInitForm();\r\n\r\n    const history = useHistory();\r\n    const [open, setOpen] = useState(false);\r\n\r\n    const closeMenu = () => {\r\n      removeTemplateState(\r\n        documentNo,\r\n        documentPart,\r\n        activityNo,\r\n        productFamily,\r\n        productLine,\r\n        language\r\n      );\r\n      history.goBack();\r\n      setOpen(false);\r\n    };\r\n\r\n    const submit = (e) => {\r\n      const result = verify(templateFormData.fields);\r\n      if (result) {\r\n        let data = {\r\n          projectNo: projectNumber,\r\n          orderNo: orderNo,\r\n          activityNo: activityNo,\r\n          description: description,\r\n          branch,\r\n          foe,\r\n          region,\r\n          override: true,\r\n          form: Base64.encode(\r\n            serialize(removeNotVisibleFields(templateFormData))\r\n          ),\r\n        };\r\n        let draftData = {\r\n          projectNo: projectNumber,\r\n          orderNo: orderNo,\r\n          activityNo: activityNo,\r\n          description: description,\r\n          branch: branch,\r\n          foe: foe,\r\n          region: region,\r\n          form: Base64.encode(serialize(templateFormData)),\r\n        };\r\n        savePDF(data, draftData, {\r\n          documentNo,\r\n          documentPart,\r\n          activityNo,\r\n          productFamily,\r\n          productLine,\r\n          language,\r\n        });\r\n      }\r\n    };\r\n\r\n    const goBack = () => {\r\n      if (\r\n        isFormUpdated(templateFormData, deserialize(Base64.decode(initData)))\r\n      ) {\r\n        setOpen(true);\r\n      } else {\r\n        removeTemplateState(\r\n          documentNo,\r\n          documentPart,\r\n          activityNo,\r\n          productFamily,\r\n          productLine,\r\n          language\r\n        );\r\n        history.goBack();\r\n      }\r\n    };\r\n\r\n    const saveDraft = (type) => {\r\n      setOpen(false);\r\n      let data = {\r\n        projectNo: projectNumber,\r\n        orderNo: orderNo,\r\n        activityNo: activityNo,\r\n        description: description,\r\n        branch: branch,\r\n        foe: foe,\r\n        region: region,\r\n        form: Base64.encode(serialize(templateFormData)),\r\n      };\r\n\r\n      const currentParams = {\r\n        documentNo,\r\n        documentPart,\r\n      };\r\n\r\n      if (type === \"save\") {\r\n        saveAndReturn(data, currentParams, {\r\n          productFamily,\r\n          productLine,\r\n          language,\r\n        }).then(() => {\r\n          setInitData(data.form);\r\n          alert(\"草稿保存成功\");\r\n        });\r\n      } else {\r\n        saveAndReturn(data, currentParams, {\r\n          productFamily,\r\n          productLine,\r\n          language,\r\n        }).then(() => {\r\n          history.goBack();\r\n          removeTemplateState(\r\n            documentNo,\r\n            documentPart,\r\n            activityNo,\r\n            productFamily,\r\n            productLine,\r\n            language\r\n          );\r\n        });\r\n      }\r\n    };\r\n\r\n    const handleToggle = (value) => () => {\r\n      const currentIndex = checked.indexOf(value);\r\n      const newChecked = [...checked];\r\n      if (currentIndex === -1) {\r\n        newChecked.push(value);\r\n      } else {\r\n        newChecked.splice(currentIndex, 1);\r\n      }\r\n      setChecked(newChecked);\r\n    };\r\n\r\n    const confirmFilter = () => {      \r\n      if (checked.length > 1) {\r\n        const checkedId = [];\r\n        checked.forEach((item) => item?.id && checkedId.push(item.id))\r\n        const fields = []\r\n        checkedId.forEach(item => {\r\n          templateFormData[\"fields\"].forEach((field) => {\r\n            field.settings.tagRules.forEach((tagRule) => {\r\n              item === tagRule.tagId && fields.push(field)\r\n            })\r\n          })\r\n        });\r\n        console.log(fields)\r\n        setTemplateForm({ ...templateFormData, fields: fields })\r\n      } else {\r\n        setTemplateForm(templateFormData)\r\n      }\r\n      setDialog(false)\r\n    }\r\n\r\n    const offlineSaving = () => {\r\n      const key = `${projectNumber}-${orderNo}-${activityNo}`\r\n      const data = {\r\n        [key]: Base64.encode(serialize(templateFormData))\r\n      }\r\n      db.cache.get(\"offlineForm\").then((res) => {\r\n        const formData = res?.data ? res.data : [];\r\n        let index = formData.findIndex((item) => Object.keys(item)[0] === Object.keys(data)[0]);\r\n        index >= 0 ? formData[index] = data : formData.push(data);\r\n        db.cache.put({ id: \"offlineForm\", data: formData })\r\n        alert('离线保存成功')\r\n      })\r\n    }\r\n\r\n    return (\r\n      <PrimaryLayout\r\n        title={i18n.ISNTAPP_TEMPLATE}\r\n        isDirectReturn={false}\r\n        isFetchAll={false}\r\n        goBack={goBack}\r\n      >\r\n        <Box className={classes.root}>\r\n          {templateFormData?.form[\"settings\"][\"tagUniverse\"].length > 0 ? <Button\r\n            onClick={() => setDialog(true)}\r\n          >\r\n            <img src={FilterIcon} alt=\"\" />\r\n          </Button>:<Box></Box>}\r\n          <Box>\r\n            <Button className={classes.btn} onClick={() => offlineSaving()}>\r\n              离线保存\r\n            </Button>\r\n            <Button className={classes.btn} onClick={() => saveDraft(\"save\")}>\r\n              {i18n.ISNTAPP_SAVE_AS_PDF}\r\n            </Button>\r\n            <Button className={classes.btn} onClick={() => submit()}>\r\n              {i18n.ISNTAPP_TEMPLATE_UPLOAD}\r\n            </Button>\r\n            </Box>\r\n        </Box>\r\n        <Box className={classes.container}>\r\n          <TitlePage {...formState} />\r\n          {(checked.length > 1 ? templateForm[\"fields\"] : fieldsState).map((field) => {\r\n            return isVisible(field)\r\n              ? componentGenerator(field, initProps(field, language))\r\n              : null;\r\n          })}\r\n        </Box>\r\n        <ConfirmModal\r\n          open={open}\r\n          onClose={closeMenu}\r\n          handleClick={() => saveDraft()}\r\n        >\r\n          {i18n.INSTALLATION_DO_YOU_WANGT_TO_SAVE_THE_DRAFT}\r\n        </ConfirmModal>\r\n        <TemplateFilter\r\n          templateForm={templateFormData}\r\n          open={dialog}\r\n          setOpen={setDialog}\r\n          handleToggle={handleToggle}\r\n          checked={checked}\r\n          confirmFilter={confirmFilter}\r\n        />\r\n      </PrimaryLayout>\r\n    );\r\n  }\r\n);\r\n\r\nconst mapStateToProps = ({ templateForm, templates, orders }, ownProps) => {\r\n  let {\r\n    activityNo,\r\n    documentPart,\r\n    orderNo,\r\n    projectNumber,\r\n    documentNo,\r\n    productFamily,\r\n    productLine,\r\n    language,\r\n  } = ownProps.match.params;\r\n\r\n  const key =\r\n    documentNo +\r\n    \"-\" +\r\n    documentPart +\r\n    \"-\" +\r\n    activityNo +\r\n    \"-\" +\r\n    productFamily +\r\n    \"-\" +\r\n    productLine +\r\n    \"-\" +\r\n    language;\r\n\r\n  let formState = {};\r\n  let fieldsState = [];\r\n  if (templateForm[key]) {\r\n    formState = {\r\n      title: templateForm[key].form?.settings.titleI18n[\r\n        tmplLangMapper[language]\r\n      ]\r\n        ? templateForm[key].form?.settings.titleI18n[tmplLangMapper[language]]\r\n        : templateForm[key].form?.settings.titleI18n.English,\r\n      description: templateForm[key].form?.settings.descriptionI18n[\r\n        tmplLangMapper[language]\r\n      ]\r\n        ? templateForm[key].form?.settings.descriptionI18n[\r\n            tmplLangMapper[language]\r\n          ]\r\n        : templateForm[key].form?.settings.descriptionI18n.English,\r\n      logos: templateForm[key].form?.settings.logos,\r\n      identifier: templateForm[key].form?.settings.identifier,\r\n    };\r\n    fieldsState = templateForm[key].fields;\r\n  }\r\n\r\n  let templateFormData = templateForm[key];\r\n\r\n  let description = templates[activityNo]?.find(\r\n    (item) =>\r\n      item.documentPart === documentPart &&\r\n      item.documentNo === documentNo &&\r\n      item.productFamily ===\r\n        (productFamily === \"null\" ? null : productFamily) &&\r\n      item.productLine === (productLine === \"null\" ? null : productLine) &&\r\n      item.language === language\r\n  ).documentDescription;\r\n  let order = orders?.[orderNo];\r\n  return {\r\n    formState,\r\n    fieldsState,\r\n    templateFormData,\r\n    activityNo,\r\n    orderNo,\r\n    projectNumber,\r\n    description,\r\n    fo: order?.fo,\r\n    region: order?.region,\r\n    prctr: order?.prctr,\r\n    productFamily,\r\n    productLine,\r\n    language,\r\n  };\r\n};\r\n\r\nconst mapDispatchToProps = (dispatch) => {\r\n  return {\r\n    storeCurrentParams: (param) => {\r\n      dispatch(action.storeCurrentParams(param));\r\n    },\r\n    getTemplateForm: (param, draftParam, expendParam) => {\r\n      dispatch(action.fetchAll(repo.type.CACHE));\r\n      return dispatch(action.fetchTemplateForm(param, draftParam, expendParam));\r\n    },\r\n    initTemplateForm: (\r\n      documentNo,\r\n      documentPart,\r\n      activityNo,\r\n      productFamily,\r\n      productLine,\r\n      language,\r\n      data,\r\n      routeParams\r\n    ) => {\r\n      return dispatch(\r\n        action.initTemplateForm(\r\n          documentNo,\r\n          documentPart,\r\n          activityNo,\r\n          productFamily,\r\n          productLine,\r\n          language,\r\n          data,\r\n          routeParams\r\n        )\r\n      );\r\n    },\r\n    savePDF: (data, draftData, param) => {\r\n      dispatch(action.uploadDocumentForm(data, draftData, param));\r\n    },\r\n    saveAndReturn: (data, currentParams, extendParam) => {\r\n      return dispatch(action.saveDraft(data, currentParams, extendParam));\r\n    },\r\n    removeTemplateState: (\r\n      documentNo,\r\n      documentPart,\r\n      activityNo,\r\n      productFamily,\r\n      productLine,\r\n      language\r\n    ) => {\r\n      dispatch(\r\n        action.removeTemplateFormState({\r\n          documentNo,\r\n          documentPart,\r\n          activityNo,\r\n          productFamily,\r\n          productLine,\r\n          language,\r\n        })\r\n      );\r\n    },\r\n  };\r\n};\r\n\r\nexport default connect(mapStateToProps, mapDispatchToProps)(TemplatePage);\r\n/*\r\n离线表单\r\n  1.如果本地存在 则先用本地离线表单\r\n  2.没有则用草稿\r\n  3.草稿没有 用接口模板\r\n\r\n  反之 如果保存了离线表单  远端草稿发生更新 本地离线表单则不能及时更新  （因为优先本地离线表单）\r\n\r\n\r\n\r\n  什么情况下草稿会更新？？？\r\n*/"]},"metadata":{},"sourceType":"module"}